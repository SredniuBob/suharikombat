<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>SUHARI KOMBAT</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        :root {
            --primary: #1a73e8;
            --secondary: #0d47a1;
            --accent: #00c853;
            --danger: #ff4444;
            --warning: #ff9800;
            --dark: #121212;
        }

        body {
            background: linear-gradient(135deg, #0a1929, #1a237e);
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            color: #4fc3f7;
            text-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }

        .nav-tabs {
            display: flex;
            overflow-x: auto;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin: -20px -20px 20px -20px;
            gap: 5px;
        }

        .nav-tabs button {
            flex: 1;
            min-width: 70px;
            padding: 12px 8px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .nav-tabs button.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stat-card, .upgrade-card, .nft-card, .game-card, .clan-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }

        .stat-card h3 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00e676;
        }

        .click-btn {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: 5px solid #4fc3f7;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px auto;
            box-shadow: 0 10px 30px rgba(26, 115, 232, 0.4);
        }

        .click-btn:active {
            transform: scale(0.95);
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent), #00e676);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 200, 83, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #666;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #ff6b6b);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ffb74d);
        }

        .limit-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .limit-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .limit-fill {
            height: 100%;
            background: linear-gradient(90deg, #00c853, #00e676);
            transition: width 0.3s;
        }

        .pvp-arena {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }

        .players {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .player {
            text-align: center;
            padding: 20px;
            min-width: 120px;
        }

        .player-score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #00e676;
            margin: 10px 0;
        }

        .minigame-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .minigame {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .minigame:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
        }

        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .nft-card {
            text-align: center;
            position: relative;
        }

        .nft-rarity {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .common { background: rgba(117, 117, 117, 0.3); color: #fff; }
        .uncommon { background: rgba(76, 175, 80, 0.3); color: #4caf50; }
        .rare { background: rgba(33, 150, 243, 0.3); color: #2196f3; }
        .epic { background: rgba(156, 39, 176, 0.3); color: #9c27b0; }
        .legendary { background: rgba(255, 215, 0, 0.3); color: #ffd700; }

        .clan-members {
            margin-top: 15px;
        }

        .clan-member {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .clan-role {
            color: #4fc3f7;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a237e;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            border: 2px solid #4fc3f7;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4fc3f7;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: rgba(0, 200, 83, 0.9);
            color: white;
            border-radius: 10px;
            transform: translateX(150%);
            transition: transform 0.3s;
            z-index: 1001;
            font-weight: bold;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .notification.warning {
            background: rgba(255, 152, 0, 0.9);
        }

        .game-field {
            width: 100%;
            height: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(79, 195, 247, 0.3);
        }

        .crypto-bubble {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s;
            animation: float 2s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .bubble-btc { background: radial-gradient(circle, #f7931a, #ff9800); }
        .bubble-eth { background: radial-gradient(circle, #627eea, #8a9ef5); }
        .bubble-doge { background: radial-gradient(circle, #c2a633, #e6c951); }
        .bubble-sol { background: radial-gradient(circle, #00ffa3, #00e676); }
        .bubble-bonus { background: radial-gradient(circle, #ff4081, #ff79b0); }

        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #1a237e, #283593);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
            transform-style: preserve-3d;
        }

        .memory-card.flipped {
            background: linear-gradient(135deg, #00c853, #00e676);
            transform: rotateY(180deg);
        }

        .memory-card.matched {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            cursor: default;
        }

        .typing-game {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .typing-word {
            font-size: 2.5rem;
            color: #4fc3f7;
            margin: 20px 0;
            letter-spacing: 3px;
        }

        .typing-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #4fc3f7;
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .typing-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .crypto-runner {
            position: relative;
            height: 200px;
            background: linear-gradient(180deg, #0a1929 0%, #1a237e 100%);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .runner-character {
            position: absolute;
            bottom: 20px;
            left: 50px;
            width: 60px;
            height: 80px;
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            border-radius: 10px;
            transition: bottom 0.2s;
        }

        .runner-obstacle {
            position: absolute;
            bottom: 20px;
            right: -50px;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff4444, #ff6b6b);
            border-radius: 5px;
        }

        .runner-coin {
            position: absolute;
            bottom: 100px;
            right: -30px;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #ffd700, #ff9800);
            border-radius: 50%;
        }

        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
            .click-btn { width: 150px; height: 150px; font-size: 1.3rem; }
            .nav-tabs button { min-width: 60px; font-size: 0.8rem; }
            .minigame-container { grid-template-columns: 1fr; }
            .memory-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>

    <div class="modal" id="promocode-modal">
        <div class="modal-content">
            <h3>Активировать промокод</h3>
            <input type="text" id="promocode-input" placeholder="Введите промокод" class="modal-input">
            <div style="display:flex;gap:10px;">
                <button class="btn" onclick="activatePromocode()">Активировать</button>
                <button class="btn btn-danger" onclick="closeModal('promocode-modal')">Закрыть</button>
            </div>
        </div>
    </div>

    <div class="modal" id="referral-input-modal">
        <div class="modal-content">
            <h3>Ввести реферальный код</h3>
            <input type="text" id="referral-input" placeholder="Введите код друга" class="modal-input">
            <div style="display:flex;gap:10px;">
                <button class="btn" onclick="useReferralCode()">Активировать</button>
                <button class="btn btn-danger" onclick="closeModal('referral-input-modal')">Закрыть</button>
            </div>
        </div>
    </div>

    <div class="modal" id="create-clan-modal">
        <div class="modal-content">
            <h3>Создать клан</h3>
            <input type="text" id="clan-name-input" placeholder="Название клана" class="modal-input">
            <input type="text" id="clan-tag-input" placeholder="Тег клана (3-5 символов)" class="modal-input">
            <textarea id="clan-description-input" placeholder="Описание клана" class="modal-input" rows="3"></textarea>
            <div style="display:flex;gap:10px;">
                <button class="btn" onclick="createClan()">Создать (1000 ₿)</button>
                <button class="btn btn-danger" onclick="closeModal('create-clan-modal')">Отмена</button>
            </div>
        </div>
    </div>

    <div class="modal" id="join-clan-modal">
        <div class="modal-content">
            <h3>Вступить в клан</h3>
            <input type="text" id="join-clan-input" placeholder="Введите тег клана" class="modal-input">
            <div style="display:flex;gap:10px;">
                <button class="btn" onclick="joinClan()">Вступить</button>
                <button class="btn btn-danger" onclick="closeModal('join-clan-modal')">Отмена</button>
            </div>
        </div>
    </div>

    <div class="nav-tabs">
        <button onclick="showSection('main')" class="active">Тапать</button>
        <button onclick="showSection('upgrades')">Улучшения</button>
        <button onclick="showSection('nft')">NFT</button>
        <button onclick="showSection('pvp')">PvP</button>
        <button onclick="showSection('minigames')">Мини-игры</button>
        <button onclick="showSection('clans')">Кланы</button>
        <button onclick="showSection('referral')">Рефералы</button>
    </div>

    <div class="container">
        <div id="main-section" class="section active">
            <div class="header">
                <h1>SUHARI KOMBAT</h1>
                <p>Кликай, майни и стань богачом!</p>
                <div style="margin-top: 10px;">
                    <button class="btn btn-warning" onclick="openModal('promocode-modal')" style="width:auto;padding:8px 15px;margin-right:10px;">
                        Промокод
                    </button>
                    <button class="btn btn-warning" onclick="openModal('referral-input-modal')" style="width:auto;padding:8px 15px;">
                        Ввести реферал
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>БАЛАНС</h3>
                    <div class="value" id="balance">0 ₿</div>
                </div>
                <div class="stat-card">
                    <h3>ЗА КЛИК</h3>
                    <div class="value" id="per-click">1 ₿</div>
                </div>
                <div class="stat-card">
                    <h3>УРОВЕНЬ</h3>
                    <div class="value" id="level">1</div>
                </div>
                <div class="stat-card">
                    <h3>АВТО-ДОХОД</h3>
                    <div class="value" id="passive-income">0 ₿/сек</div>
                </div>
            </div>

            <div class="limit-container">
                <div class="limit-bar">
                    <div class="limit-fill" id="limit-fill" style="width: 100%"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                    <span>Кликов: <strong id="current-clicks">50</strong>/<strong id="max-clicks">50</strong></span>
                    <span id="reset-time">Восстановление: 2:00</span>
                </div>
                <button class="btn btn-warning" id="reset-btn" onclick="resetClickLimit()" style="display:none;">
                    Восстановить лимит (100 ₿)
                </button>
            </div>

            <button class="click-btn" id="click-btn">
                Тыкать
                <div style="font-size: 1rem; margin-top: 10px; color: #00e676;">
                    +<span id="click-value">1</span> ₿ за клик
                </div>
            </button>

            <div style="text-align: center;">
                <button class="btn" onclick="showSection('upgrades')">
                    СМОТРЕТЬ УЛУЧШЕНИЯ
                </button>
            </div>
        </div>

        <div id="upgrades-section" class="section">
            <div class="header">
                <h1>УЛУЧШЕНИЯ</h1>
                <p>Улучшай свою ферму и лимиты!</p>
            </div>
            <div id="upgrades-container"></div>
        </div>

        <div id="nft-section" class="section">
            <div class="header">
                <h1>NFT КОЛЛЕКЦИЯ</h1>
                <p>Коллекционируй уникальные предметы!</p>
            </div>
            
            <div class="nft-grid" id="nft-shop">
                <div class="nft-card" onclick="buyNftBox('basic')">
                    <h3>БАЗОВЫЙ</h3>
                    <div class="nft-rarity common">обычный</div>
                    <p>Стоимость: 1,000 ₿</p>
                    <button class="btn">Купить</button>
                </div>
                <div class="nft-card" onclick="buyNftBox('premium')">
                    <h3>ПРЕМИУМ</h3>
                    <div class="nft-rarity rare">редкий</div>
                    <p>Стоимость: 5,000 ₿</p>
                    <button class="btn">Купить</button>
                </div>
                <div class="nft-card" onclick="buyNftBox('legendary')">
                    <h3>ЛЕГЕНДАРНЫЙ</h3>
                    <div class="nft-rarity legendary">легендарный</div>
                    <p>Стоимость: 10,000 ₿</p>
                    <button class="btn">Купить</button>
                </div>
            </div>

            <h3 style="margin: 20px 0 10px 0;">Ваши NFT:</h3>
            <div id="nft-inventory"></div>
        </div>

        <div id="pvp-section" class="section">
            <div class="header">
                <h1>PvP АРЕНА</h1>
                <p>Сражайся с другими игроками!</p>
            </div>

            <div class="pvp-arena" id="battle-arena" style="display:none;">
                <h2 id="battle-title">Бой с Ботом</h2>
                <div class="players">
                    <div class="player">
                        <div>Вы</div>
                        <div class="player-score" id="player1-score">0</div>
                    </div>
                    <div style="font-size: 2rem; display: flex; align-items: center;">VS</div>
                    <div class="player">
                        <div id="opponent-name">Бот</div>
                        <div class="player-score" id="player2-score">0</div>
                    </div>
                </div>
                <div id="battle-timer" style="font-size: 3rem; color: #ff4444; margin: 20px 0;">60</div>
                <button class="btn btn-danger" onclick="pvpClick()" id="pvp-click-btn">КЛИКАТЬ!</button>
            </div>

            <div id="pvp-menu">
                <div class="upgrade-card">
                    <h3>Бой с ботом</h3>
                    <p>Сразитесь с ИИ-ботом. Ставка: 10 ₿</p>
                    <button class="btn" onclick="startPvPBattle('bot')">Начать бой</button>
                </div>
                <div class="upgrade-card">
                    <h3>Случайный противник</h3>
                    <p>Найдите реального игрока. Ставка: 50 ₿</p>
                    <button class="btn" onclick="startPvPBattle('player')">Найти бой</button>
                </div>
            </div>
        </div>

        <div id="minigames-section" class="section">
            <div class="header">
                <h1>МИНИ-ИГРЫ</h1>
                <p>Зарабатывай токены разными способами!</p>
            </div>

            <div class="minigame-container">
                <div class="minigame" onclick="startMinigame('clicker')">
                    <h3>Кликай</h3>
                    <p>Кликай как можно быстрее за 10 секунд!</p>
                    <div style="color: #00e676; margin-top: 10px;">Приз: до 150 ₿</div>
                </div>
                <div class="minigame" onclick="startMinigame('bubble')">
                    <h3>Лопай крипту</h3>
                    <p>Кликай на появляющиеся крипто-пузыри!</p>
                    <div style="color: #00e676; margin-top: 10px;">Приз: до 200 ₿</div>
                </div>
                <div class="minigame" onclick="startMinigame('memory')">
                    <h3>Память</h3>
                    <p>Найди пары одинаковых карточек</p>
                    <div style="color: #00e676; margin-top: 10px;">Приз: до 250 ₿</div>
                </div>
                <div class="minigame" onclick="startMinigame('typing')">
                    <h3>Крипто-печать</h3>
                    <p>Печатай крипто-слова на скорость</p>
                    <div style="color: #00e676; margin-top: 10px;">Приз: до 300 ₿</div>
                </div>
                <div class="minigame" onclick="startMinigame('runner')">
                    <h3>Крипто-ранер</h3>
                    <p>Прыгай через препятствия и собирай монеты</p>
                    <div style="color: #00e676; margin-top: 10px;">Приз: до 400 ₿</div>
                </div>
                <div class="minigame" onclick="startMinigame('number')">
                    <h3>Угадай число</h3>
                    <p>Угадай число от 1 до 100 за 5 попыток</p>
                    <div style="color: #00e676; margin-top: 10px;">Приз: до 200 ₿</div>
                </div>
            </div>

            <div id="minigame-container" style="display:none;"></div>
        </div>

        <div id="clans-section" class="section">
            <div class="header">
                <h1>КЛАНЫ</h1>
                <p>Объединяйся с другими игроками!</p>
            </div>

            <div id="clan-info" style="display:none;">
                <div class="clan-card">
                    <h3 id="current-clan-name">Название клана</h3>
                    <div style="background: rgba(79, 195, 247, 0.2); padding: 5px 15px; border-radius: 20px; display: inline-block; margin: 10px 0;">
                        <strong id="current-clan-tag">#TAG</strong>
                    </div>
                    <p id="current-clan-description">Описание клана</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Участники</h3>
                            <div class="value" id="clan-members-count">1</div>
                        </div>
                        <div class="stat-card">
                            <h3>Общая сила</h3>
                            <div class="value" id="clan-total-power">0 ₿</div>
                        </div>
                        <div class="stat-card">
                            <h3>Ваша роль</h3>
                            <div class="value" id="clan-user-role">Участник</div>
                        </div>
                    </div>

                    <div class="clan-members" id="clan-members-list"></div>

                    <button class="btn btn-danger" onclick="leaveClan()">Покинуть клан</button>
                </div>
            </div>

            <div id="no-clan">
                <div class="upgrade-card">
                    <h3>Создать клан</h3>
                    <p>Создайте свой клан и приглашайте друзей!</p>
                    <button class="btn" onclick="openModal('create-clan-modal')">Создать клан</button>
                </div>

                <div class="upgrade-card">
                    <h3>Вступить в клан</h3>
                    <p>Вступите в существующий клан по приглашению</p>
                    <button class="btn" onclick="openModal('join-clan-modal')">Вступить в клан</button>
                </div>

                <h3 style="margin: 30px 0 15px 0;">Топ кланов:</h3>
                <div id="top-clans-list"></div>
            </div>
        </div>

        <div id="referral-section" class="section">
            <div class="header">
                <h1>РЕФЕРАЛЬНАЯ СИСТЕМА</h1>
                <p>Приглашай друзей и получай бонусы!</p>
            </div>

            <div class="upgrade-card">
                <h3>Ваш реферальный код:</h3>
                <div style="font-size: 2rem; letter-spacing: 3px; background: rgba(79, 195, 247, 0.2); padding: 15px; border-radius: 10px; margin: 15px 0; border: 2px dashed #4fc3f7;">
                    <span id="referral-code">CRYPTO123</span>
                </div>
                <button class="btn" onclick="copyReferralCode()">Копировать код</button>
                <button class="btn btn-warning" onclick="openModal('referral-input-modal')" style="margin-top: 10px;">
                    Ввести код друга
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Приглашено друзей</h3>
                    <div class="value" id="referrals-count">0</div>
                </div>
                <div class="stat-card">
                    <h3>Заработано с рефералов</h3>
                    <div class="value" id="referral-earnings">0 ₿</div>
                </div>
            </div>

            <div class="upgrade-card">
                <h3>Бонусы за приглашения:</h3>
                <ul style="padding-left: 20px; margin-top: 10px;">
                    <li>1 друг: +10% к доходу за клик</li>
                    <li>3 друга: +1 к лимиту кликов</li>
                    <li>5 друзей: +25% к доходу за клик</li>
                    <li>10 друзей: ×2 к призам в мини-играх</li>
                </ul>
            </div>

            <h3 style="margin: 30px 0 15px 0;">Ваши рефералы:</h3>
            <div id="referrals-list"></div>
        </div>
    </div>

    <script>
        // ====== ИНИЦИАЛИЗАЦИЯ TELEGRAM ======
        let tg = window.Telegram?.WebApp || null;
        
        if (tg) {
            tg.ready();
            tg.expand();
            tg.setBackgroundColor('#0a1929');
            tg.setHeaderColor('#0a1929');
        }

        // ====== СОСТОЯНИЕ ИГРЫ ======
        let gameState = {
            balance: 1,
            per_click: 1,
            passive_per_sec: 0,
            level: 1,
            experience: 0,
            total_clicks: 0,
            
            click_limit: 50,
            click_limit_used: 0,
            click_limit_reset: Date.now() + 120000,
            
            upgrades: {
                basic_rig: 0,
                gpu_farm: 0,
                asic_miner: 0,
                mining_pool: 0,
                click_limit_boost: 0,
                click_speed: 0,
                referral_boost: 0
            },
            
            nfts: [],
            nft_boost: 1,
            
            referral_code: generateReferralCode(),
            referrals: [],
            referral_earnings: 0,
            used_referral_code: null,
            
            pvp_wins: 0,
            pvp_losses: 0,
            
            clan: null,
            
            used_promocodes: [],
            
            minigame_stats: {
                clicker: { played: 0, best: 0 },
                bubble: { played: 0, best: 0 },
                memory: { played: 0, best: 0 },
                typing: { played: 0, best: 0 },
                runner: { played: 0, best: 0 },
                number: { played: 0, wins: 0 }
            },
            
            statistics: {
                total_earned: 0,
                total_spent: 0,
                play_time: 0,
                first_play: Date.now()
            },
            
            version: "1.0.0"
        };

        // ====== СИСТЕМА АВТОСОХРАНЕНИЯ В JSON ======
        const API_URL = window.location.origin; // Используем текущий домен
        
        // Генерируем ID пользователя
        function getUserId() {
            if (tg?.initDataUnsafe?.user?.id) {
                return 'tg_' + tg.initDataUnsafe.user.id;
            }
            
            let userId = localStorage.getItem('cryptoKombat_userId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('cryptoKombat_userId', userId);
            }
            return userId;
        }

        // Сохраняем игру
        async function saveGame() {
            try {
                const userId = getUserId();
                
                // Сохраняем локально как запасной вариант
                localStorage.setItem('cryptoKombat_save_' + userId, JSON.stringify(gameState));
                
                // Отправляем на сервер
                const saveData = {
                    userId: userId,
                    gameData: gameState,
                    timestamp: Date.now()
                };
                
                // Пробуем отправить на сервер
                try {
                    const response = await fetch('/api/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(saveData)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Server error');
                    }
                    
                    console.log('Game saved to server');
                } catch (serverError) {
                    console.log('Server save failed, using local storage');
                }
                
                return true;
            } catch (error) {
                console.error('Save error:', error);
                return false;
            }
        }

        // Загружаем игру
        async function loadGame() {
            try {
                const userId = getUserId();
                
                // Пробуем загрузить с сервера
                try {
                    const response = await fetch(`/api/load?userId=${encodeURIComponent(userId)}`);
                    
                    if (response.ok) {
                        const serverData = await response.json();
                        
                        // Проверяем, что данные корректны
                        if (serverData && serverData.balance !== undefined) {
                            Object.assign(gameState, serverData);
                            console.log('Game loaded from server');
                            return true;
                        }
                    }
                } catch (serverError) {
                    console.log('Server load failed, trying local storage');
                }
                
                // Пробуем загрузить из локального хранилища
                const localSave = localStorage.getItem('cryptoKombat_save_' + userId);
                if (localSave) {
                    const loadedData = JSON.parse(localSave);
                    Object.assign(gameState, loadedData);
                    console.log('Game loaded from local storage');
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('Load error:', error);
                return false;
            }
        }

        // ====== ОСНОВНЫЕ ФУНКЦИИ ======
        async function initGame() {
            // Загружаем игру
            const loaded = await loadGame();
            if (loaded) {
                showNotification('Прогресс загружен!', 'success');
            } else {
                showNotification('Новая игра начата!', 'success');
            }
            
            updateUI();
            renderUpgrades();
            loadNFTInventory();
            updateReferralUI();
            updateClanUI();
            startPassiveIncome();
            startClickLimitTimer();
            
            checkDailyBonus();
            
            // Автосохранение каждые 30 секунд
            setInterval(async () => {
                await saveGame();
            }, 30000);
            
            console.log('Игра инициализирована');
        }
        
        function updateUI() {
            document.getElementById('balance').textContent = formatNumber(gameState.balance) + ' ₿';
            document.getElementById('per-click').textContent = formatNumber(gameState.per_click * gameState.nft_boost) + ' ₿';
            document.getElementById('click-value').textContent = Math.floor(gameState.per_click * gameState.nft_boost);
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('passive-income').textContent = gameState.passive_per_sec.toFixed(2) + ' ₿/сек';
            
            updateClickLimitUI();
        }

        function formatNumber(num) {
            return Math.floor(num).toLocaleString('ru-RU');
        }

        // ====== СИСТЕМА КЛИКОВ ======
        document.getElementById('click-btn').addEventListener('click', async function() {
            if (gameState.click_limit_used >= gameState.click_limit) {
                showNotification('Лимит кликов исчерпан!', 'error');
                return;
            }
            
            this.style.transform = 'scale(0.95)';
            setTimeout(() => this.style.transform = 'scale(1)', 100);
            
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
            
            const clickValue = Math.floor(gameState.per_click * gameState.nft_boost);
            gameState.balance += clickValue;
            gameState.total_clicks++;
            gameState.statistics.total_earned += clickValue;
            gameState.click_limit_used++;
            gameState.experience++;
            
            if (gameState.experience >= gameState.level * 100) {
                gameState.level++;
                gameState.experience = 0;
                gameState.per_click += Math.floor(gameState.level / 2);
                showNotification('Уровень ' + gameState.level + '! +' + Math.floor(gameState.level / 2) + ' к клику', 'success');
                
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('heavy');
                }
            }
            
            updateUI();
            await saveGame();
        });

        // ====== ЛИМИТ КЛИКОВ ======
        function updateClickLimitUI() {
            const used = gameState.click_limit_used;
            const total = gameState.click_limit;
            const percentage = Math.max(0, ((total - used) / total) * 100);
            
            document.getElementById('limit-fill').style.width = percentage + '%';
            document.getElementById('current-clicks').textContent = total - used;
            document.getElementById('max-clicks').textContent = total;
            
            const resetBtn = document.getElementById('reset-btn');
            if (used >= total) {
                resetBtn.style.display = 'block';
                document.getElementById('limit-fill').style.background = 'linear-gradient(90deg, #ff4444, #ff9800)';
            } else {
                resetBtn.style.display = 'none';
                document.getElementById('limit-fill').style.background = 'linear-gradient(90deg, #00c853, #00e676)';
            }
        }

        function startClickLimitTimer() {
            setInterval(() => {
                const now = Date.now();
                if (now >= gameState.click_limit_reset) {
                    gameState.click_limit_used = 0;
                    gameState.click_limit_reset = now + 120000;
                    updateClickLimitUI();
                }
                
                const timeLeft = Math.max(0, gameState.click_limit_reset - now);
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                document.getElementById('reset-time').textContent = 
                    'Восстановление: ' + minutes + ':' + seconds.toString().padStart(2, '0');
                    
                gameState.statistics.play_time++;
                    
            }, 1000);
        }

        async function resetClickLimit() {
            if (gameState.click_limit_used < gameState.click_limit) {
                showNotification('Лимит еще не исчерпан!', 'warning');
                return;
            }
            
            const cost = 100;
            if (gameState.balance < cost) {
                showNotification('Недостаточно средств! Нужно ' + cost + ' ₿', 'error');
                return;
            }
            
            gameState.balance -= cost;
            gameState.statistics.total_spent += cost;
            gameState.click_limit_used = 0;
            gameState.click_limit_reset = Date.now() + 120000;
            updateClickLimitUI();
            updateUI();
            await saveGame();
            showNotification('Лимит кликов восстановлен!', 'success');
        }

        // ====== УЛУЧШЕНИЯ ======
        const upgrades = [
            { id: 'basic_rig', name: 'Базовый минимум', desc: 'Простая видеокарта', cost: 10, click: 1, passive: 0.01 },
            { id: 'gpu_farm', name: 'GPU Ферма', desc: 'Несколько видеокарт', cost: 50, click: 5, passive: 0.05 },
            { id: 'asic_miner', name: 'Майнер', desc: 'Специализированный процессор', cost: 200, click: 20, passive: 0.2 },
            { id: 'mining_pool', name: 'Супер ферма', desc: 'Объединенная мощность', cost: 500, click: 50, passive: 0.5 },
            { id: 'click_limit_boost', name: 'Улучшение лимита', desc: '+10 к лимиту кликов', cost: 100, limit_bonus: 10 },
            { id: 'click_speed', name: 'Скорость клика', desc: '+5 к силе клика', cost: 500, click: 5 },
            { id: 'referral_boost', name: 'Реферальный буст', desc: '+10% к реферальному доходу', cost: 300, referral_bonus: 0.1 }
        ];

        async function buyUpgrade(upgradeId) {
            const upgrade = upgrades.find(u => u.id === upgradeId);
            if (!upgrade) return;
            
            const currentLevel = gameState.upgrades[upgradeId] || 0;
            const cost = Math.floor(upgrade.cost * Math.pow(1.5, currentLevel));
            
            if (gameState.balance < cost) {
                showNotification('Недостаточно средств!', 'error');
                return;
            }
            
            gameState.balance -= cost;
            gameState.statistics.total_spent += cost;
            gameState.upgrades[upgradeId] = currentLevel + 1;
            
            if (upgrade.click) {
                gameState.per_click += upgrade.click;
            }
            if (upgrade.passive) {
                gameState.passive_per_sec += upgrade.passive;
            }
            if (upgrade.limit_bonus) {
                gameState.click_limit += upgrade.limit_bonus;
            }
            
            updateUI();
            renderUpgrades();
            await saveGame();
            
            showNotification('Куплено: ' + upgrade.name, 'success');
        }

        function renderUpgrades() {
            const container = document.getElementById('upgrades-container');
            container.innerHTML = '';
            
            upgrades.forEach(upgrade => {
                const currentLevel = gameState.upgrades[upgrade.id] || 0;
                const cost = Math.floor(upgrade.cost * Math.pow(1.5, currentLevel));
                const canBuy = gameState.balance >= cost;
                
                const card = document.createElement('div');
                card.className = 'upgrade-card';
                card.innerHTML = `
                    <h3>${upgrade.name} (${currentLevel})</h3>
                    <p>${upgrade.desc}</p>
                    <div style="color: #00e676; margin: 10px 0;">
                        ${upgrade.click ? '+' + upgrade.click + ' к клику' : ''}
                        ${upgrade.passive ? '<br>+' + upgrade.passive + ' ₿/сек' : ''}
                        ${upgrade.limit_bonus ? '<br>+' + upgrade.limit_bonus + ' к лимиту' : ''}
                        ${upgrade.referral_bonus ? '<br>+' + upgrade.referral_bonus * 100 + '% к рефералам' : ''}
                    </div>
                    <button class="btn" onclick="buyUpgrade('${upgrade.id}')" ${!canBuy ? 'disabled' : ''}>
                        ${currentLevel === 0 ? 'КУПИТЬ' : 'УЛУЧШИТЬ'} ЗА ${formatNumber(cost)} ₿
                    </button>
                `;
                container.appendChild(card);
            });
        }

        // ====== НОВЫЕ МИНИ-ИГРЫ ======
        function startBubbleGame() {
            const container = document.getElementById('minigame-container');
            container.innerHTML = `
                <div class="header">
                    <h2>Лопай крипту</h2>
                    <p>Кликай на крипто-пузыри, пока не закончится время!</p>
                    <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                        <div>
                            <div style="font-size: 2rem; color: #ff9800;" id="bubble-timer">30</div>
                            <div>Время</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; color: #00e676;" id="bubble-score">0</div>
                            <div>Счет</div>
                        </div>
                    </div>
                    <div class="game-field" id="bubble-field"></div>
                    <button class="btn btn-warning" onclick="backToMinigames()" style="margin-top: 20px;">
                        Назад к играм
                    </button>
                </div>
            `;
            
            document.querySelector('.minigame-container').style.display = 'none';
            container.style.display = 'block';
            
            let score = 0;
            let timeLeft = 30;
            let gameActive = true;
            const bubbleField = document.getElementById('bubble-field');
            const scoreElement = document.getElementById('bubble-score');
            const timerElement = document.getElementById('bubble-timer');
            
            const cryptoTypes = [
                { class: 'bubble-btc', value: 10, symbol: '₿' },
                { class: 'bubble-eth', value: 15, symbol: 'Ξ' },
                { class: 'bubble-doge', value: 5, symbol: 'Ð' },
                { class: 'bubble-sol', value: 20, symbol: '◎' },
                { class: 'bubble-bonus', value: 50, symbol: '★' }
            ];
            
            function createBubble() {
                if (!gameActive) return;
                
                const crypto = cryptoTypes[Math.floor(Math.random() * cryptoTypes.length)];
                const bubble = document.createElement('div');
                bubble.className = 'crypto-bubble ' + crypto.class;
                bubble.textContent = crypto.symbol;
                bubble.dataset.value = crypto.value;
                
                const size = 40 + Math.random() * 30;
                bubble.style.width = size + 'px';
                bubble.style.height = size + 'px';
                
                const x = Math.random() * (bubbleField.clientWidth - size);
                const y = Math.random() * (bubbleField.clientHeight - size);
                bubble.style.left = x + 'px';
                bubble.style.top = y + 'px';
                
                bubble.onclick = function() {
                    if (!gameActive) return;
                    
                    score += parseInt(this.dataset.value);
                    scoreElement.textContent = score;
                    
                    this.style.transform = 'scale(1.5)';
                    this.style.opacity = '0';
                    
                    setTimeout(() => bubbleField.removeChild(this), 200);
                    
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                };
                
                bubbleField.appendChild(bubble);
                
                setTimeout(() => {
                    if (bubbleField.contains(bubble)) {
                        bubbleField.removeChild(bubble);
                    }
                }, 2000 + Math.random() * 2000);
            }
            
            const bubbleInterval = setInterval(createBubble, 500);
            
            const timer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(bubbleInterval);
                    clearInterval(timer);
                    
                    const reward = Math.min(score, 200);
                    gameState.balance += reward;
                    gameState.statistics.total_earned += reward;
                    
                    if (score > gameState.minigame_stats.bubble.best) {
                        gameState.minigame_stats.bubble.best = score;
                    }
                    
                    container.innerHTML += `
                        <div style="text-align:center; margin-top:20px; padding:20px; background:rgba(255,255,255,0.05); border-radius:15px;">
                            <h3>Игра окончена!</h3>
                            <p>Ваш счет: ${score}</p>
                            <p>Выигрыш: ${reward} ₿</p>
                            <p>Рекорд: ${gameState.minigame_stats.bubble.best}</p>
                            <button class="btn" onclick="backToMinigames()">Вернуться к играм</button>
                        </div>
                    `;
                    
                    updateUI();
                    saveGame();
                }
            }, 1000);
            
            for (let i = 0; i < 5; i++) {
                setTimeout(createBubble, i * 100);
            }
        }

        function startMemoryGame() {
            const container = document.getElementById('minigame-container');
            container.innerHTML = `
                <div class="header">
                    <h2>Игра на память</h2>
                    <p>Найди все пары карточек!</p>
                    <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                        <div>
                            <div style="font-size: 2rem; color: #ff9800;" id="memory-moves">0</div>
                            <div>Ходы</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; color: #00e676;" id="memory-pairs">0/8</div>
                            <div>Пары</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; color: #4fc3f7;" id="memory-time">60</div>
                            <div>Время</div>
                        </div>
                    </div>
                    <div class="memory-grid" id="memory-grid"></div>
                    <button class="btn btn-warning" onclick="backToMinigames()" style="margin-top: 20px;">
                        Назад к играм
                    </button>
                </div>
            `;
            
            document.querySelector('.minigame-container').style.display = 'none';
            container.style.display = 'block';
            
            const symbols = ['₿', 'Ξ', 'Ð', '◎', '★', '⚡', '💰', '🎯'];
            let cards = [...symbols, ...symbols];
            let flippedCards = [];
            let matchedPairs = 0;
            let moves = 0;
            let timeLeft = 60;
            let gameActive = true;
            
            cards = cards.sort(() => Math.random() - 0.5);
            
            const grid = document.getElementById('memory-grid');
            const movesElement = document.getElementById('memory-moves');
            const pairsElement = document.getElementById('memory-pairs');
            const timeElement = document.getElementById('memory-time');
            
            cards.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.index = index;
                card.dataset.symbol = symbol;
                card.innerHTML = '?';
                
                card.onclick = function() {
                    if (!gameActive || flippedCards.length >= 2 || 
                        this.classList.contains('flipped') || 
                        this.classList.contains('matched')) return;
                    
                    this.classList.add('flipped');
                    this.textContent = symbol;
                    flippedCards.push(this);
                    
                    if (flippedCards.length === 2) {
                        moves++;
                        movesElement.textContent = moves;
                        
                        const [card1, card2] = flippedCards;
                        if (card1.dataset.symbol === card2.dataset.symbol) {
                            setTimeout(() => {
                                card1.classList.add('matched');
                                card2.classList.add('matched');
                                matchedPairs++;
                                pairsElement.textContent = matchedPairs + '/8';
                                
                                if (matchedPairs === 8) {
                                    endMemoryGame(true);
                                }
                            }, 500);
                        } else {
                            setTimeout(() => {
                                card1.classList.remove('flipped');
                                card2.classList.remove('flipped');
                                card1.textContent = '?';
                                card2.textContent = '?';
                            }, 1000);
                        }
                        
                        flippedCards = [];
                    }
                };
                
                grid.appendChild(card);
            });
            
            const timer = setInterval(() => {
                if (!gameActive) {
                    clearInterval(timer);
                    return;
                }
                
                timeLeft--;
                timeElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    endMemoryGame(false);
                }
            }, 1000);
            
            function endMemoryGame(win) {
                gameActive = false;
                clearInterval(timer);
                
                const baseReward = win ? 250 : Math.floor(matchedPairs * 20);
                const timeBonus = win ? Math.floor(timeLeft * 2) : 0;
                const movesBonus = win ? Math.max(0, 50 - moves * 2) : 0;
                const totalReward = Math.min(baseReward + timeBonus + movesBonus, 250);
                
                gameState.balance += totalReward;
                gameState.statistics.total_earned += totalReward;
                
                if (win && moves < gameState.minigame_stats.memory.best || gameState.minigame_stats.memory.best === 0) {
                    gameState.minigame_stats.memory.best = moves;
                }
                
                container.innerHTML += `
                    <div style="text-align:center; margin-top:20px; padding:20px; background:rgba(255,255,255,0.05); border-radius:15px;">
                        <h3>${win ? 'Победа!' : 'Время вышло!'}</h3>
                        <p>Найдено пар: ${matchedPairs}/8</p>
                        <p>Сделано ходов: ${moves}</p>
                        <p>Время: ${60 - timeLeft} сек</p>
                        <p>Выигрыш: ${totalReward} ₿</p>
                        ${win ? '<p>Рекорд: ' + gameState.minigame_stats.memory.best + ' ходов</p>' : ''}
                        <button class="btn" onclick="backToMinigames()">Вернуться к играм</button>
                    </div>
                `;
                
                updateUI();
                saveGame();
            }
        }

        function startTypingGame() {
            const container = document.getElementById('minigame-container');
            container.innerHTML = `
                <div class="header">
                    <h2>Крипто-печать</h2>
                    <p>Напечатай крипто-слово как можно быстрее!</p>
                    <div class="typing-game">
                        <div class="typing-word" id="typing-word">BITCOIN</div>
                        <input type="text" class="typing-input" id="typing-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                        <div class="typing-stats">
                            <div>
                                <div style="font-size: 1.5rem; color: #ff9800;" id="typing-time">60</div>
                                <div>Время</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; color: #00e676;" id="typing-score">0</div>
                                <div>Слов</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; color: #4fc3f7;" id="typing-wpm">0</div>
                                <div>WPM</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-warning" onclick="backToMinigames()" style="margin-top: 20px;">
                        Назад к играм
                    </button>
                </div>
            `;
            
            document.querySelector('.minigame-container').style.display = 'none';
            container.style.display = 'block';
            
            const cryptoWords = [
                'BITCOIN', 'ETHEREUM', 'SOLANA', 'CARDANO', 'POLKADOT',
                'AVALANCHE', 'POLYGON', 'CHAINLINK', 'UNISWAP', 'SHIBAINU',
                'DOGECOIN', 'LITECOIN', 'RIPPLE', 'MONERO', 'STELLAR'
            ];
            
            let score = 0;
            let timeLeft = 60;
            let gameActive = true;
            let startTime = Date.now();
            let currentWord = '';
            
            const wordElement = document.getElementById('typing-word');
            const inputElement = document.getElementById('typing-input');
            const scoreElement = document.getElementById('typing-score');
            const timeElement = document.getElementById('typing-time');
            const wpmElement = document.getElementById('typing-wpm');
            
            function newWord() {
                currentWord = cryptoWords[Math.floor(Math.random() * cryptoWords.length)];
                wordElement.textContent = currentWord;
                inputElement.value = '';
                inputElement.focus();
            }
            
            inputElement.oninput = function() {
                if (!gameActive) return;
                
                if (this.value.toUpperCase() === currentWord) {
                    score++;
                    scoreElement.textContent = score;
                    
                    const timeTaken = (Date.now() - startTime) / 1000 / 60;
                    const wpm = Math.round((currentWord.length / 5) / timeTaken);
                    wpmElement.textContent = wpm;
                    
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                    
                    startTime = Date.now();
                    newWord();
                }
            };
            
            const timer = setInterval(() => {
                if (!gameActive) {
                    clearInterval(timer);
                    return;
                }
                
                timeLeft--;
                timeElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(timer);
                    
                    const reward = Math.min(score * 20, 300);
                    gameState.balance += reward;
                    gameState.statistics.total_earned += reward;
                    
                    if (score > gameState.minigame_stats.typing.best) {
                        gameState.minigame_stats.typing.best = score;
                    }
                    
                    container.innerHTML += `
                        <div style="text-align:center; margin-top:20px; padding:20px; background:rgba(255,255,255,0.05); border-radius:15px;">
                            <h3>Игра окончена!</h3>
                            <p>Напечатано слов: ${score}</p>
                            <p>Выигрыш: ${reward} ₿</p>
                            <p>Рекорд: ${gameState.minigame_stats.typing.best} слов</p>
                            <button class="btn" onclick="backToMinigames()">Вернуться к играм</button>
                        </div>
                    `;
                    
                    updateUI();
                    saveGame();
                }
            }, 1000);
            
            newWord();
        }

        function startRunnerGame() {
            const container = document.getElementById('minigame-container');
            container.innerHTML = `
                <div class="header">
                    <h2>Крипто-ранер</h2>
                    <p>Прыгай (кликай) и собирай монеты!</p>
                    <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                        <div>
                            <div style="font-size: 2rem; color: #ff9800;" id="runner-distance">0</div>
                            <div>Дистанция</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; color: #00e676;" id="runner-coins">0</div>
                            <div>Монеты</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; color: #ff4444;" id="runner-speed">1.0x</div>
                            <div>Скорость</div>
                        </div>
                    </div>
                    <div class="crypto-runner" id="runner-game">
                        <div class="runner-character" id="runner-character"></div>
                    </div>
                    <p style="text-align:center; margin-top:10px;">Кликай в любом месте чтобы прыгнуть!</p>
                    <button class="btn btn-warning" onclick="backToMinigames()" style="margin-top: 20px;">
                        Назад к играм
                    </button>
                </div>
            `;
            
            document.querySelector('.minigame-container').style.display = 'none';
            container.style.display = 'block';
            
            const gameContainer = document.getElementById('runner-game');
            const character = document.getElementById('runner-character');
            const distanceElement = document.getElementById('runner-distance');
            const coinsElement = document.getElementById('runner-coins');
            const speedElement = document.getElementById('runner-speed');
            
            let distance = 0;
            let coins = 0;
            let speed = 1.0;
            let isJumping = false;
            let gameActive = true;
            let obstacles = [];
            let coinItems = [];
            let gameInterval;
            
            document.addEventListener('click', jump);
            
            function jump() {
                if (!gameActive || isJumping) return;
                
                isJumping = true;
                character.style.bottom = '100px';
                
                setTimeout(() => {
                    character.style.bottom = '20px';
                    setTimeout(() => {
                        isJumping = false;
                    }, 200);
                }, 300);
                
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
            }
            
            function createObstacle() {
                const obstacle = document.createElement('div');
                obstacle.className = 'runner-obstacle';
                obstacle.style.right = '-50px';
                gameContainer.appendChild(obstacle);
                obstacles.push(obstacle);
            }
            
            function createCoin() {
                if (Math.random() > 0.3) return;
                
                const coin = document.createElement('div');
                coin.className = 'runner-coin';
                coin.style.right = '-30px';
                coin.style.bottom = (50 + Math.random() * 100) + 'px';
                gameContainer.appendChild(coin);
                coinItems.push(coin);
            }
            
            function updateGame() {
                if (!gameActive) return;
                
                distance += speed;
                distanceElement.textContent = Math.floor(distance);
                
                if (distance % 100 === 0) {
                    speed += 0.1;
                    speedElement.textContent = speed.toFixed(1) + 'x';
                }
                
                obstacles.forEach((obstacle, index) => {
                    const currentRight = parseFloat(obstacle.style.right);
                    obstacle.style.right = (currentRight + speed * 5) + 'px';
                    
                    if (currentRight > 50 && currentRight < 110 && !isJumping) {
                        endRunnerGame();
                    }
                    
                    if (currentRight > gameContainer.clientWidth) {
                        gameContainer.removeChild(obstacle);
                        obstacles.splice(index, 1);
                    }
                });
                
                coinItems.forEach((coin, index) => {
                    const currentRight = parseFloat(coin.style.right);
                    coin.style.right = (currentRight + speed * 5) + 'px';
                    
                    const charBottom = parseInt(character.style.bottom);
                    const coinBottom = parseInt(coin.style.bottom);
                    
                    if (currentRight > 50 && currentRight < 110 && 
                        Math.abs(charBottom - coinBottom) < 40) {
                        coins++;
                        coinsElement.textContent = coins;
                        gameContainer.removeChild(coin);
                        coinItems.splice(index, 1);
                        
                        if (tg?.HapticFeedback) {
                            tg.HapticFeedback.impactOccurred('light');
                        }
                    }
                    
                    if (currentRight > gameContainer.clientWidth) {
                        gameContainer.removeChild(coin);
                        coinItems.splice(index, 1);
                    }
                });
                
                if (Math.random() > 0.98) createObstacle();
                if (Math.random() > 0.95) createCoin();
            }
            
            function endRunnerGame() {
                gameActive = false;
                clearInterval(gameInterval);
                document.removeEventListener('click', jump);
                
                const distanceReward = Math.floor(distance / 10);
                const coinsReward = coins * 5;
                const totalReward = Math.min(distanceReward + coinsReward, 400);
                
                gameState.balance += totalReward;
                gameState.statistics.total_earned += totalReward;
                
                if (distance > gameState.minigame_stats.runner.best) {
                    gameState.minigame_stats.runner.best = Math.floor(distance);
                }
                
                container.innerHTML += `
                    <div style="text-align:center; margin-top:20px; padding:20px; background:rgba(255,255,255,0.05); border-radius:15px;">
                        <h3>Конец игры!</h3>
                        <p>Пройдено дистанции: ${Math.floor(distance)}</p>
                        <p>Собрано монет: ${coins}</p>
                        <p>Максимальная скорость: ${speed.toFixed(1)}x</p>
                        <p>Выигрыш: ${totalReward} ₿</p>
                        <p>Рекорд: ${gameState.minigame_stats.runner.best}</p>
                        <button class="btn" onclick="backToMinigames()">Вернуться к играм</button>
                    </div>
                `;
                
                updateUI();
                saveGame();
            }
            
            gameInterval = setInterval(updateGame, 50);
            createObstacle();
        }

        async function startMinigame(type) {
            const container = document.getElementById('minigame-container');
            
            document.querySelector('.minigame-container').style.display = 'none';
            container.style.display = 'block';
            container.innerHTML = '';
            
            if (gameState.minigame_stats[type]) {
                gameState.minigame_stats[type].played++;
            }
            
            switch(type) {
                case 'clicker':
                    startClickerGame(container);
                    break;
                case 'bubble':
                    startBubbleGame();
                    break;
                case 'memory':
                    startMemoryGame();
                    break;
                case 'typing':
                    startTypingGame();
                    break;
                case 'runner':
                    startRunnerGame();
                    break;
                case 'number':
                    startNumberGame(container);
                    break;
                default:
                    backToMinigames();
            }
        }

        function backToMinigames() {
            const gamesContainer = document.querySelector('.minigame-container');
            const gameContainer = document.getElementById('minigame-container');
            
            if (gamesContainer && gameContainer) {
                gamesContainer.style.display = 'grid';
                gameContainer.style.display = 'none';
                gameContainer.innerHTML = '';
            }
        }

        // ====== ОСТАЛЬНЫЕ ФУНКЦИИ ======
        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.classList.add('error');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(sectionId + '-section').classList.add('active');
            
            document.querySelectorAll('.nav-tabs button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            if (sectionId !== 'minigames') {
                backToMinigames();
            }
            
            if (sectionId === 'upgrades') renderUpgrades();
            if (sectionId === 'nft') loadNFTInventory();
            if (sectionId === 'clans') updateClanUI();
            if (sectionId === 'referral') updateReferralUI();
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        const promocodes = {
            'CRYPTO100': { reward: 100, uses: 9999 },
            'WELCOME50': { reward: 50, uses: 9999 },
            'FIRST200': { reward: 200, uses: 9999 },
            'BONUS300': { reward: 300, uses: 9999 },
            'NEWPLAYER': { reward: 500, uses: 1 }
        };

        async function activatePromocode() {
            const input = document.getElementById('promocode-input');
            const code = input.value.trim().toUpperCase();
            
            if (!code) {
                showNotification('Введите промокод!', 'error');
                return;
            }
            
            if (gameState.used_promocodes.includes(code)) {
                showNotification('Этот промокод уже использован!', 'error');
                return;
            }
            
            if (!promocodes[code]) {
                showNotification('Неверный промокод!', 'error');
                return;
            }
            
            const reward = promocodes[code].reward;
            gameState.balance += reward;
            gameState.statistics.total_earned += reward;
            gameState.used_promocodes.push(code);
            
            input.value = '';
            closeModal('promocode-modal');
            
            showNotification('Промокод активирован! +' + reward + ' ₿', 'success');
            updateUI();
            await saveGame();
        }

        function startPassiveIncome() {
            setInterval(() => {
                if (gameState.passive_per_sec > 0) {
                    gameState.balance += gameState.passive_per_sec / 10;
                    gameState.statistics.total_earned += gameState.passive_per_sec / 10;
                    updateUI();
                }
            }, 100);
        }

        function checkDailyBonus() {
            const today = new Date().toDateString();
            const lastBonus = localStorage.getItem('cryptoKombat_last_bonus');
            
            if (lastBonus !== today) {
                const bonus = 100 + (gameState.daily_streak || 0) * 10;
                gameState.balance += bonus;
                gameState.statistics.total_earned += bonus;
                gameState.daily_streak = (gameState.daily_streak || 0) + 1;
                localStorage.setItem('cryptoKombat_last_bonus', today);
                
                setTimeout(() => {
                    showNotification('Ежедневный бонус! +' + bonus + ' ₿ (серия: ' + gameState.daily_streak + ' дней)', 'success');
                    updateUI();
                    saveGame();
                }, 1000);
            }
        }

        // ====== ГЛОБАЛЬНЫЕ ФУНКЦИИ ======
        window.buyUpgrade = buyUpgrade;
        window.showSection = showSection;
        window.resetClickLimit = resetClickLimit;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.activatePromocode = activatePromocode;
        window.startMinigame = startMinigame;
        window.backToMinigames = backToMinigames;

        // ====== ЗАПУСК ИГРЫ ======
        document.addEventListener('DOMContentLoaded', async () => {
            await initGame();
        });
    </script>
</body>
</html>
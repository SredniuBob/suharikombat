<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>SUHARI KOMBAT</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        :root {
            --primary: #1a73e8;
            --secondary: #0d47a1;
            --accent: #00c853;
            --danger: #ff4444;
            --warning: #ff9800;
            --dark: #121212;
        }

        body {
            background: linear-gradient(135deg, #0a1929, #1a237e);
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            color: #4fc3f7;
            text-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }

        .nav-tabs {
            display: flex;
            overflow-x: auto;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin: -20px -20px 20px -20px;
            gap: 5px;
        }

        .nav-tabs button {
            flex: 1;
            min-width: 70px;
            padding: 12px 8px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .nav-tabs button.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stat-card, .upgrade-card, .nft-card, .game-card, .clan-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }

        .stat-card h3 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00e676;
        }

        .click-btn {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: 5px solid #4fc3f7;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px auto;
            box-shadow: 0 10px 30px rgba(26, 115, 232, 0.4);
        }

        .click-btn:active {
            transform: scale(0.95);
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent), #00e676);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 200, 83, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #666;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #ff6b6b);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ffb74d);
        }

        .limit-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .limit-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .limit-fill {
            height: 100%;
            background: linear-gradient(90deg, #00c853, #00e676);
            transition: width 0.3s;
            position: relative;
            overflow: hidden;
        }

        .limit-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.3) 50%, 
                rgba(255,255,255,0) 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .minigame-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .minigame {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .minigame:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
        }

        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .nft-card {
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .nft-card:hover {
            transform: translateY(-5px);
        }

        .nft-rarity {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .common { background: rgba(117, 117, 117, 0.3); color: #fff; }
        .uncommon { background: rgba(76, 175, 80, 0.3); color: #4caf50; }
        .rare { background: rgba(33, 150, 243, 0.3); color: #2196f3; }
        .epic { background: rgba(156, 39, 176, 0.3); color: #9c27b0; }
        .legendary { background: rgba(255, 215, 0, 0.3); color: #ffd700; }

        .clan-members {
            margin-top: 15px;
        }

        .clan-member {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .clan-role {
            color: #4fc3f7;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a237e;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            border: 2px solid #4fc3f7;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4fc3f7;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: rgba(0, 200, 83, 0.9);
            color: white;
            border-radius: 10px;
            transform: translateX(150%);
            transition: transform 0.3s;
            z-index: 1001;
            font-weight: bold;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .notification.warning {
            background: rgba(255, 152, 0, 0.9);
        }

        .game-field {
            width: 100%;
            height: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(79, 195, 247, 0.3);
        }

        .crypto-bubble {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s;
            animation: float 2s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .bubble-btc { background: radial-gradient(circle, #f7931a, #ff9800); }
        .bubble-eth { background: radial-gradient(circle, #627eea, #8a9ef5); }
        .bubble-doge { background: radial-gradient(circle, #c2a633, #e6c951); }
        .bubble-sol { background: radial-gradient(circle, #00ffa3, #00e676); }
        .bubble-bonus { background: radial-gradient(circle, #ff4081, #ff79b0); }

        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #1a237e, #283593);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
            transform-style: preserve-3d;
        }

        .memory-card.flipped {
            background: linear-gradient(135deg, #00c853, #00e676);
            transform: rotateY(180deg);
        }

        .memory-card.matched {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            cursor: default;
        }

        .typing-game {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .typing-word {
            font-size: 2.5rem;
            color: #4fc3f7;
            margin: 20px 0;
            letter-spacing: 3px;
        }

        .typing-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #4fc3f7;
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .typing-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .crypto-runner {
            position: relative;
            height: 200px;
            background: linear-gradient(180deg, #0a1929 0%, #1a237e 100%);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .runner-character {
            position: absolute;
            bottom: 20px;
            left: 50px;
            width: 60px;
            height: 80px;
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            border-radius: 10px;
            transition: bottom 0.2s;
        }

        .runner-obstacle {
            position: absolute;
            bottom: 20px;
            right: -50px;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff4444, #ff6b6b);
            border-radius: 5px;
        }

        .runner-coin {
            position: absolute;
            bottom: 100px;
            right: -30px;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #ffd700, #ff9800);
            border-radius: 50%;
        }

        .minigame-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .minigame-timer {
            font-size: 2rem;
            color: #ff9800;
            font-weight: bold;
        }

        .minigame-score {
            font-size: 2rem;
            color: #00e676;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
            .click-btn { width: 150px; height: 150px; font-size: 1.3rem; }
            .nav-tabs button { min-width: 60px; font-size: 0.8rem; }
            .minigame-container { grid-template-columns: 1fr; }
            .memory-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>

    <div class="modal" id="promocode-modal">
        <div class="modal-content">
            <h3>Активировать промокод</h3>
            <input type="text" id="promocode-input" placeholder="Введите промокод" class="modal-input">
            <div style="display:flex;gap:10px;">
                <button class="btn" onclick="activatePromocode()">Активировать</button>
                <button class="btn btn-danger" onclick="closeModal('promocode-modal')">Закрыть</button>
            </div>
        </div>
    </div>

    <div class="modal" id="referral-input-modal">
        <div class="modal-content">
            <h3>Ввести реферальный код</h3>
            <input type="text" id="referral-input" placeholder="Введите код друга" class="modal-input">
            <div style="display:flex;gap:10px;">
                <button class="btn" onclick="useReferralCode()">Активировать</button>
                <button class="btn btn-danger" onclick="closeModal('referral-input-modal')">Закрыть</button>
            </div>
        </div>
    </div>

    <div class="modal" id="create-clan-modal">
        <div class="modal-content">
            <h3>Создать клан</h3>
            <input type="text" id="clan-name-input" placeholder="Название клана" class="modal-input">
            <input type="text" id="clan-tag-input" placeholder="Тег клана (3-5 символов)" class="modal-input">
            <textarea id="clan-description-input" placeholder="Описание клана" class="modal-input" rows="3"></textarea>
            <div style="display:flex;gap:10px;">
                <button class="btn" onclick="createClan()">Создать (1000 ₿)</button>
                <button class="btn btn-danger" onclick="closeModal('create-clan-modal')">Отмена</button>
            </div>
        </div>
    </div>

    <div class="modal" id="join-clan-modal">
        <div class="modal-content">
            <h3>Вступить в клан</h3>
            <input type="text" id="join-clan-input" placeholder="Введите тег клана" class="modal-input">
            <div style="display:flex;gap:10px;">
                <button class="btn" onclick="joinClan()">Вступить</button>
                <button class="btn btn-danger" onclick="closeModal('join-clan-modal')">Отмена</button>
            </div>
        </div>
    </div>

    <div class="modal" id="nft-open-modal">
        <div class="modal-content">
            <h3>Открыть NFT</h3>
            <div id="nft-preview" style="text-align:center;margin:20px 0;">
                <!-- NFT будет отображаться здесь -->
            </div>
            <div id="nft-buttons" style="display:flex;gap:10px;">
                <button class="btn" onclick="equipNFT()">Надеть</button>
                <button class="btn btn-danger" onclick="sellNFT()">Продать</button>
                <button class="btn btn-warning" onclick="closeModal('nft-open-modal')">Закрыть</button>
            </div>
        </div>
    </div>

    <div class="nav-tabs">
        <button onclick="showSection('main')" class="active">Тапать</button>
        <button onclick="showSection('upgrades')">Улучшения</button>
        <button onclick="showSection('nft')">NFT</button>
        <button onclick="showSection('minigames')">Мини-игры</button>
        <button onclick="showSection('clans')">Кланы</button>
        <button onclick="showSection('referral')">Рефералы</button>
    </div>

    <div class="container">
        <div id="main-section" class="section active">
            <div class="header">
                <h1>SUHARI KOMBAT</h1>
                <p>Кликай, майни и стань богачом!</p>
                <div style="margin-top: 10px;">
                    <button class="btn btn-warning" onclick="openModal('promocode-modal')" style="width:auto;padding:8px 15px;margin-right:10px;">
                        Промокод
                    </button>
                    <button class="btn btn-warning" onclick="openModal('referral-input-modal')" style="width:auto;padding:8px 15px;">
                        Ввести реферал
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ЗА КЛИК</h3>
                    <div class="value" id="per-click">1 ₿</div>
                </div>
                <div class="stat-card">
                    <h3>УРОВЕНЬ</h3>
                    <div class="value" id="level">1</div>
                </div>
                <div class="stat-card">
                    <h3>АВТО-ДОХОД</h3>
                    <div class="value" id="passive-income">0 ₿/сек</div>
                </div>
                <div class="stat-card">
                    <h3>БАЛАНС</h3>
                    <div class="value" id="balance">0 ₿</div>
                </div>
            </div>

            <div class="limit-container">
                <div class="limit-bar">
                    <div class="limit-fill" id="limit-fill" style="width: 100%"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                    <span>Кликов: <strong id="current-clicks">50</strong>/<strong id="max-clicks">50</strong></span>
                    <span id="reset-time">Восстановление: 2:00</span>
                </div>
                <button class="btn btn-warning" id="reset-btn" onclick="resetClickLimit()" style="display:none;">
                    Восстановить лимит (<span id="reset-cost">100</span> ₿)
                </button>
            </div>

            <button class="click-btn" id="click-btn">
                Тыкать
                <div style="font-size: 1rem; margin-top: 10px; color: #00e676;">
                    +<span id="click-value">1</span> ₿ за клик
                </div>
            </button>

            <div style="text-align: center;">
                <button class="btn" onclick="showSection('upgrades')">
                    СМОТРЕТЬ УЛУЧШЕНИЯ
                </button>
            </div>
        </div>

        <div id="upgrades-section" class="section">
            <div class="header">
                <h1>УЛУЧШЕНИЯ</h1>
                <p>Улучшай свою ферму и лимиты!</p>
            </div>
            <div id="upgrades-container"></div>
        </div>

        <div id="nft-section" class="section">
            <div class="header">
                <h1>NFT КОЛЛЕКЦИЯ</h1>
                <p>Коллекционируй уникальные предметы!</p>
            </div>
            
            <div class="nft-grid" id="nft-shop">
                <div class="nft-card" onclick="buyNftBox('basic')">
                    <h3>БАЗОВЫЙ</h3>
                    <div class="nft-rarity common">обычный</div>
                    <p>Стоимость: 1,000 ₿</p>
                    <p style="font-size:0.8rem;">Шансы: обычный 70%, редкий 25%, эпический 5%</p>
                    <button class="btn">Купить</button>
                </div>
                <div class="nft-card" onclick="buyNftBox('premium')">
                    <h3>ПРЕМИУМ</h3>
                    <div class="nft-rarity rare">редкий</div>
                    <p>Стоимость: 5,000 ₿</p>
                    <p style="font-size:0.8rem;">Шансы: обычный 50%, редкий 30%, эпический 15%, легендарный 5%</p>
                    <button class="btn">Купить</button>
                </div>
                <div class="nft-card" onclick="buyNftBox('legendary')">
                    <h3>ЛЕГЕНДАРНЫЙ</h3>
                    <div class="nft-rarity legendary">легендарный</div>
                    <p>Стоимость: 10,000 ₿</p>
                    <p style="font-size:0.8rem;">Шансы: редкий 40%, эпический 35%, легендарный 25%</p>
                    <button class="btn">Купить</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>NFT БУСТ</h3>
                    <div class="value" id="nft-boost">+0%</div>
                </div>
                <div class="stat-card">
                    <h3>NFT В ИНВЕНТАРЕ</h3>
                    <div class="value" id="nft-count">0</div>
                </div>
                <div class="stat-card">
                    <h3>НАДЕТО NFT</h3>
                    <div class="value" id="equipped-nft">0</div>
                </div>
                <div class="stat-card">
                    <h3>СТОИМОСТЬ NFT</h3>
                    <div class="value" id="nft-value">0 ₿</div>
                </div>
            </div>

            <h3 style="margin: 20px 0 10px 0;">Надетые NFT:</h3>
            <div id="equipped-nfts-container"></div>

            <h3 style="margin: 20px 0 10px 0;">Ваши NFT:</h3>
            <div id="nft-inventory"></div>
        </div>

        <div id="minigames-section" class="section">
            <div class="header">
                <h1>МИНИ-ИГРЫ</h1>
                <p>Зарабатывай токены разными способами!</p>
            </div>

            <div class="minigame-container">
                <div class="minigame" onclick="startMinigame('clicker')">
                    <h3>Кликай</h3>
                    <p>Кликай как можно быстрее за 10 секунд!</p>
                    <div style="color: #00e676; margin-top: 10px;">Приз: до 150 ₿</div>
                </div>
                <div class="minigame" onclick="startMinigame('bubble')">
                    <h3>Лопай крипту</h3>
                    <p>Кликай на появляющиеся крипто-пузыри!</p>
                    <div style="color: #00e676; margin-top: 10px;">Приз: до 200 ₿</div>
                </div>
                <div class="minigame" onclick="startMinigame('memory')">
                    <h3>Память</h3>
                    <p>Найди пары одинаковых карточек</p>
                    <div style="color: #00e676; margin-top: 10px;">Приз: до 250 ₿</div>
                </div>
                <div class="minigame" onclick="startMinigame('typing')">
                    <h3>Крипто-печать</h3>
                    <p>Печатай крипто-слова на скорость</p>
                    <div style="color: #00e676; margin-top: 10px;">Приз: до 300 ₿</div>
                </div>
                <div class="minigame" onclick="startMinigame('runner')">
                    <h3>Крипто-ранер</h3>
                    <p>Прыгай через препятствия и собирай монеты</p>
                    <div style="color: #00e676; margin-top: 10px;">Приз: до 400 ₿</div>
                </div>
                <div class="minigame" onclick="startMinigame('number')">
                    <h3>Угадай число</h3>
                    <p>Угадай число от 1 до 100 за 5 попыток</p>
                    <div style="color: #00e676; margin-top: 10px;">Приз: до 200 ₿</div>
                </div>
            </div>

            <div id="minigame-container" style="display:none;"></div>
        </div>

        <div id="clans-section" class="section">
            <div class="header">
                <h1>КЛАНЫ</h1>
                <p>Объединяйся с другими игроками!</p>
            </div>

            <div id="clan-info" style="display:none;">
                <div class="clan-card">
                    <h3 id="current-clan-name">Название клана</h3>
                    <div style="background: rgba(79, 195, 247, 0.2); padding: 5px 15px; border-radius: 20px; display: inline-block; margin: 10px 0;">
                        <strong id="current-clan-tag">#TAG</strong>
                    </div>
                    <p id="current-clan-description">Описание клана</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Участники</h3>
                            <div class="value" id="clan-members-count">1</div>
                        </div>
                        <div class="stat-card">
                            <h3>Общая сила</h3>
                            <div class="value" id="clan-total-power">0 ₿</div>
                        </div>
                        <div class="stat-card">
                            <h3>Клан Уровень</h3>
                            <div class="value" id="clan-level">1</div>
                        </div>
                        <div class="stat-card">
                            <h3>Ваша роль</h3>
                            <div class="value" id="clan-user-role">Участник</div>
                        </div>
                    </div>

                    <div class="clan-members" id="clan-members-list"></div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-danger" onclick="leaveClan()">Покинуть клан</button>
                        <button class="btn btn-warning" onclick="openClanSettings()" style="margin-top:10px;">Настройки клана</button>
                    </div>
                </div>
            </div>

            <div id="no-clan">
                <div class="upgrade-card">
                    <h3>Создать клан</h3>
                    <p>Создайте свой клан и приглашайте друзей!</p>
                    <p style="color:#ff9800;margin:10px 0;">Стоимость: 1000 ₿</p>
                    <p style="font-size:0.9rem;opacity:0.8;">Бонусы клана: +5% к доходу за каждого участника, общие достижения, клановые бои</p>
                    <button class="btn" onclick="openModal('create-clan-modal')">Создать клан</button>
                </div>

                <div class="upgrade-card">
                    <h3>Вступить в клан</h3>
                    <p>Вступите в существующий клан по приглашению</p>
                    <button class="btn" onclick="openModal('join-clan-modal')">Вступить в клан</button>
                </div>

                <h3 style="margin: 30px 0 15px 0;">Топ кланов:</h3>
                <div id="top-clans-list"></div>
            </div>
        </div>

        <div id="referral-section" class="section">
            <div class="header">
                <h1>РЕФЕРАЛЬНАЯ СИСТЕМА</h1>
                <p>Приглашай друзей и получай бонусы!</p>
            </div>

            <div class="upgrade-card">
                <h3>Ваш реферальный код:</h3>
                <div style="font-size: 2rem; letter-spacing: 3px; background: rgba(79, 195, 247, 0.2); padding: 15px; border-radius: 10px; margin: 15px 0; border: 2px dashed #4fc3f7;">
                    <span id="referral-code">Загрузка...</span>
                </div>
                <button class="btn" onclick="copyReferralCode()">Копировать код</button>
                <button class="btn btn-warning" onclick="openModal('referral-input-modal')" style="margin-top: 10px;">
                    Ввести код друга
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Приглашено друзей</h3>
                    <div class="value" id="referrals-count">0</div>
                </div>
                <div class="stat-card">
                    <h3>Заработано с рефералов</h3>
                    <div class="value" id="referral-earnings">0 ₿</div>
                </div>
                <div class="stat-card">
                    <h3>Реферальный бонус</h3>
                    <div class="value" id="referral-bonus">+0%</div>
                </div>
                <div class="stat-card">
                    <h3>Доход за 24ч</h3>
                    <div class="value" id="referral-daily">0 ₿</div>
                </div>
            </div>

            <div class="upgrade-card">
                <h3>Бонусы за приглашения:</h3>
                <ul style="padding-left: 20px; margin-top: 10px;">
                    <li>1 друг: +10% к доходу за клик</li>
                    <li>3 друга: +1 к лимиту кликов</li>
                    <li>5 друзей: +25% к доходу за клик</li>
                    <li>10 друзей: ×2 к призам в мини-играх</li>
                    <li>25 друзей: +50% к пассивному доходу</li>
                    <li>50 друзей: ×3 к шансу на редкие NFT</li>
                </ul>
            </div>

            <h3 style="margin: 30px 0 15px 0;">Ваши рефералы:</h3>
            <div id="referrals-list"></div>
        </div>
    </div>

    <script>
        // ====== ИНИЦИАЛИЗАЦИЯ TELEGRAM ======
        let tg = window.Telegram?.WebApp || null;
        
        if (tg) {
            tg.ready();
            tg.expand();
            tg.setBackgroundColor('#0a1929');
            tg.setHeaderColor('#0a1929');
        }

        // ====== СОСТОЯНИЕ ИГРЫ ======
        let gameState = {
            balance: 1,
            per_click: 1,
            passive_per_sec: 0,
            level: 1,
            experience: 0,
            total_clicks: 0,
            
            click_limit: 50,
            click_limit_used: 0,
            last_reset_time: Date.now(),
            
            upgrades: {
                basic_rig: 0,
                gpu_farm: 0,
                asic_miner: 0,
                mining_pool: 0,
                click_limit_boost: 0,
                click_speed: 0,
                referral_boost: 0
            },
            
            nfts: [],
            equipped_nfts: [],
            nft_boost: 1,
            selected_nft: null,
            
            referral_code: "",
            referrals: [],
            referral_earnings: 0,
            used_referral_code: null,
            referral_bonus: 1,
            referral_daily_earnings: {},
            
            clan: null,
            clan_invites: [],
            
            used_promocodes: [],
            
            minigame_stats: {
                clicker: { played: 0, best: 0 },
                bubble: { played: 0, best: 0 },
                memory: { played: 0, best: 0 },
                typing: { played: 0, best: 0 },
                runner: { played: 0, best: 0 },
                number: { played: 0, wins: 0 }
            },
            
            statistics: {
                total_earned: 0,
                total_spent: 0,
                play_time: 0,
                first_play: Date.now()
            },
            
            version: "1.0.0"
        };

        // ====== NFT СИСТЕМА ======
        const nftTypes = {
            click_boost: { name: "Бустер клика", description: "Увеличивает доход за клик" },
            passive_boost: { name: "Генератор", description: "Увеличивает пассивный доход" },
            limit_boost: { name: "Расширитель", description: "Увеличивает лимит кликов" },
            luck_boost: { name: "Амулет удачи", description: "Увеличивает шанс на бонус" },
            referral_boost: { name: "Реферальный магнит", description: "Увеличивает доход с рефералов" }
        };

        const nftRarities = {
            common: { multiplier: 0.1, color: "#9e9e9e", price: 100 },
            uncommon: { multiplier: 0.25, color: "#4caf50", price: 250 },
            rare: { multiplier: 0.5, color: "#2196f3", price: 500 },
            epic: { multiplier: 1, color: "#9c27b0", price: 1000 },
            legendary: { multiplier: 2, color: "#ffd700", price: 2500 }
        };

        // ====== КЛАНЫ ======
        const clansData = {
            "CRYPTO": { name: "Крипто-Воины", tag: "CRYPTO", members: 15, total_power: 15000, level: 3 },
            "BTC": { name: "Биткоин Элита", tag: "BTC", members: 8, total_power: 12000, level: 2 },
            "ETH": { name: "Эфириум Гильдия", tag: "ETH", members: 12, total_power: 18000, level: 4 },
            "DOGE": { name: "Дождики", tag: "DOGE", members: 25, total_power: 22000, level: 5 }
        };

        // ====== МИНИ-ИГРЫ ======
        let currentGame = null;
        let gameInterval = null;
        let gameTimeout = null;

        // Слова для игры в печать
        const cryptoWords = [
            "BITCOIN", "ETHEREUM", "SOLANA", "POLKADOT", "CARDANO",
            "AVALANCHE", "POLYGON", "ARBITRUM", "OPTIMISM", "COSMOS",
            "NEAR", "ALGORAND", "TEZOS", "FLOW", "HARMONY"
        ];

        // ====== СИСТЕМА АВТОСОХРАНЕНИЯ ======
        function getUserId() {
            if (tg?.initDataUnsafe?.user?.id) {
                return 'tg_' + tg.initDataUnsafe.user.id;
            }
            
            let userId = localStorage.getItem('cryptoKombat_userId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('cryptoKombat_userId', userId);
            }
            return userId;
        }

        async function saveGame() {
            try {
                const userId = getUserId();
                localStorage.setItem('cryptoKombat_save_' + userId, JSON.stringify(gameState));
                return true;
            } catch (error) {
                console.error('Save error:', error);
                return false;
            }
        }

        async function loadGame() {
            try {
                const userId = getUserId();
                const localSave = localStorage.getItem('cryptoKombat_save_' + userId);
                if (localSave) {
                    const loadedData = JSON.parse(localSave);
                    Object.assign(gameState, loadedData);
                    
                    // Генерируем новый реферальный код если его нет
                    if (!gameState.referral_code) {
                        gameState.referral_code = generateNewReferralCode();
                        await saveGame();
                    }
                    
                    console.log('Game loaded from local storage');
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('Load error:', error);
                return false;
            }
        }

        function generateNewReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // ====== ОСНОВНЫЕ ФУНКЦИИ ======
        async function initGame() {
            const loaded = await loadGame();
            
            if (!loaded) {
                gameState.referral_code = generateNewReferralCode();
                gameState.last_reset_time = Date.now();
                await saveGame();
                showNotification('Новая игра начата!', 'success');
            } else {
                const now = Date.now();
                const timeSinceLastReset = now - gameState.last_reset_time;
                
                if (timeSinceLastReset >= 120000) {
                    gameState.click_limit_used = 0;
                    gameState.last_reset_time = now;
                    showNotification('Клики восстановлены за время отсутствия!', 'success');
                }
                
                showNotification('Прогресс загружен!', 'success');
            }
            
            updateUI();
            renderUpgrades();
            loadNFTInventory();
            updateReferralUI();
            updateClanUI();
            startPassiveIncome();
            startClickLimitTimer();
            
            checkDailyBonus();
            updateReferralBonuses();
            
            setInterval(async () => {
                await saveGame();
            }, 30000);
            
            console.log('Игра инициализирована');
        }
        
        function updateUI() {
            // Рассчитываем общий буст
            let totalBoost = 1;
            if (gameState.nft_boost > 1) totalBoost *= gameState.nft_boost;
            if (gameState.referral_bonus > 1) totalBoost *= gameState.referral_bonus;
            
            document.getElementById('balance').textContent = formatNumber(gameState.balance) + ' ₿';
            document.getElementById('per-click').textContent = formatNumber(gameState.per_click * totalBoost) + ' ₿';
            document.getElementById('click-value').textContent = Math.floor(gameState.per_click * totalBoost);
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('passive-income').textContent = gameState.passive_per_sec.toFixed(2) + ' ₿/сек';
            document.getElementById('reset-cost').textContent = 100 * gameState.level;
            document.getElementById('nft-boost').textContent = '+' + Math.floor((totalBoost - 1) * 100) + '%';
            document.getElementById('nft-count').textContent = gameState.nfts.length;
            document.getElementById('equipped-nft').textContent = gameState.equipped_nfts.length;
            document.getElementById('nft-value').textContent = formatNumber(calculateNFTValue()) + ' ₿';
        }

        function formatNumber(num) {
            return Math.floor(num).toLocaleString('ru-RU');
        }

        // ====== СИСТЕМА КЛИКОВ ======
        document.getElementById('click-btn').addEventListener('click', async function() {
            if (gameState.click_limit_used >= gameState.click_limit) {
                showNotification('Лимит кликов исчерпан! Ждите восстановления (2 минуты)', 'error');
                return;
            }
            
            this.style.transform = 'scale(0.95)';
            setTimeout(() => this.style.transform = 'scale(1)', 100);
            
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
            
            // Рассчитываем бусты
            let totalBoost = 1;
            if (gameState.nft_boost > 1) totalBoost *= gameState.nft_boost;
            if (gameState.referral_bonus > 1) totalBoost *= gameState.referral_bonus;
            
            // Шанс на критический удар (5%)
            let clickMultiplier = 1;
            if (Math.random() < 0.05) {
                clickMultiplier = 2;
                showNotification('Критический удар! x2 к доходу!', 'success');
            }
            
            const clickValue = Math.floor(gameState.per_click * totalBoost * clickMultiplier);
            gameState.balance += clickValue;
            gameState.total_clicks++;
            gameState.statistics.total_earned += clickValue;
            gameState.click_limit_used++;
            gameState.experience++;
            
            // Добавляем опыт за рефералов
            if (gameState.referrals.length > 0) {
                gameState.experience += Math.floor(gameState.referrals.length / 2);
            }
            
            if (gameState.experience >= gameState.level * 100) {
                gameState.level++;
                gameState.experience = 0;
                gameState.per_click += Math.floor(gameState.level / 2);
                showNotification('Уровень ' + gameState.level + '! +' + Math.floor(gameState.level / 2) + ' к клику', 'success');
                
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('heavy');
                }
            }
            
            updateUI();
            await saveGame();
        });

        // ====== ЛИМИТ КЛИКОВ ======
        function updateClickLimitUI() {
            const used = gameState.click_limit_used;
            const total = gameState.click_limit;
            const available = Math.max(0, total - used);
            const percentage = (available / total) * 100;
            
            document.getElementById('limit-fill').style.width = percentage + '%';
            document.getElementById('current-clicks').textContent = available;
            document.getElementById('max-clicks').textContent = total;
            
            const resetBtn = document.getElementById('reset-btn');
            if (used >= total) {
                resetBtn.style.display = 'block';
                document.getElementById('limit-fill').style.background = 'linear-gradient(90deg, #ff4444, #ff9800)';
            } else {
                resetBtn.style.display = 'none';
                document.getElementById('limit-fill').style.background = 'linear-gradient(90deg, #00c853, #00e676)';
            }
        }

        function startClickLimitTimer() {
            console.log('Таймер восстановления кликов запущен');
            
            setInterval(async () => {
                const now = Date.now();
                const timeSinceLastReset = now - gameState.last_reset_time;
                
                if (timeSinceLastReset >= 120000) {
                    console.log('Восстанавливаем клики! Прошло времени: ' + timeSinceLastReset + 'мс');
                    
                    gameState.click_limit_used = 0;
                    gameState.last_reset_time = now;
                    
                    updateClickLimitUI();
                    updateUI();
                    await saveGame();
                    
                    showNotification('Лимит кликов восстановлен!', 'success');
                    
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                }
                
                const timeUntilNextReset = 120000 - timeSinceLastReset;
                const timeLeft = Math.max(0, timeUntilNextReset);
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                
                document.getElementById('reset-time').textContent = 
                    'Восстановление: ' + minutes + ':' + seconds.toString().padStart(2, '0');
                
                gameState.statistics.play_time++;
                    
            }, 1000);
        }

        async function resetClickLimit() {
            if (gameState.click_limit_used < gameState.click_limit) {
                showNotification('Лимит еще не исчерпан!', 'warning');
                return;
            }
            
            const cost = 100 * gameState.level;
            if (gameState.balance < cost) {
                showNotification('Недостаточно средств! Нужно ' + cost + ' ₿', 'error');
                return;
            }
            
            gameState.balance -= cost;
            gameState.statistics.total_spent += cost;
            gameState.click_limit_used = 0;
            gameState.last_reset_time = Date.now();
            
            updateClickLimitUI();
            updateUI();
            await saveGame();
            
            showNotification('Лимит кликов восстановлен!', 'success');
            
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('heavy');
            }
        }

        // ====== УЛУЧШЕНИЯ ======
        const upgrades = [
            { 
                id: 'basic_rig', 
                name: 'Базовый минимум', 
                desc: 'Простая видеокарта', 
                cost: 10, 
                click: 1, 
                passive: 0.01,
                max_level: 10
            },
            { 
                id: 'gpu_farm', 
                name: 'GPU Ферма', 
                desc: 'Несколько видеокарт', 
                cost: 50, 
                click: 5, 
                passive: 0.05,
                max_level: 5
            },
            { 
                id: 'asic_miner', 
                name: 'Майнер', 
                desc: 'Специализированный процессор', 
                cost: 200, 
                click: 20, 
                passive: 0.2,
                max_level: 3
            },
            { 
                id: 'mining_pool', 
                name: 'Супер ферма', 
                desc: 'Объединенная мощность', 
                cost: 500, 
                click: 50, 
                passive: 0.5,
                max_level: 2
            },
            { 
                id: 'click_limit_boost', 
                name: 'Улучшение лимита', 
                desc: '+10 к лимиту кликов', 
                cost: 100, 
                limit_bonus: 10,
                max_level: 5
            },
            { 
                id: 'click_speed', 
                name: 'Скорость клика', 
                desc: '+5 к силе клика', 
                cost: 500, 
                click: 5,
                max_level: 10
            },
            { 
                id: 'referral_boost', 
                name: 'Реферальный буст', 
                desc: '+10% к реферальному доходу', 
                cost: 300, 
                referral_bonus: 0.1,
                max_level: 5
            }
        ];

        async function buyUpgrade(upgradeId) {
            const upgrade = upgrades.find(u => u.id === upgradeId);
            if (!upgrade) return;
            
            const currentLevel = gameState.upgrades[upgradeId] || 0;
            
            // Проверка максимального уровня
            if (upgrade.max_level && currentLevel >= upgrade.max_level) {
                showNotification('Максимальный уровень достигнут!', 'warning');
                return;
            }
            
            const cost = Math.floor(upgrade.cost * Math.pow(1.5, currentLevel));
            
            if (gameState.balance < cost) {
                showNotification('Недостаточно средств!', 'error');
                return;
            }
            
            gameState.balance -= cost;
            gameState.statistics.total_spent += cost;
            gameState.upgrades[upgradeId] = currentLevel + 1;
            
            if (upgrade.click) {
                gameState.per_click += upgrade.click;
            }
            if (upgrade.passive) {
                gameState.passive_per_sec += upgrade.passive;
            }
            if (upgrade.limit_bonus) {
                gameState.click_limit += upgrade.limit_bonus;
            }
            if (upgrade.referral_bonus) {
                gameState.referral_bonus += upgrade.referral_bonus;
            }
            
            updateUI();
            renderUpgrades();
            await saveGame();
            
            showNotification('Куплено: ' + upgrade.name, 'success');
        }

        function renderUpgrades() {
            const container = document.getElementById('upgrades-container');
            container.innerHTML = '';
            
            upgrades.forEach(upgrade => {
                const currentLevel = gameState.upgrades[upgrade.id] || 0;
                const cost = Math.floor(upgrade.cost * Math.pow(1.5, currentLevel));
                const canBuy = gameState.balance >= cost;
                const isMaxLevel = upgrade.max_level && currentLevel >= upgrade.max_level;
                
                const card = document.createElement('div');
                card.className = 'upgrade-card';
                card.innerHTML = `
                    <h3>${upgrade.name} (${currentLevel}${upgrade.max_level ? '/' + upgrade.max_level : ''})</h3>
                    <p>${upgrade.desc}</p>
                    <div style="color: #00e676; margin: 10px 0;">
                        ${upgrade.click ? '+' + upgrade.click + ' к клику' : ''}
                        ${upgrade.passive ? '<br>+' + upgrade.passive + ' ₿/сек' : ''}
                        ${upgrade.limit_bonus ? '<br>+' + upgrade.limit_bonus + ' к лимиту' : ''}
                        ${upgrade.referral_bonus ? '<br>+' + (upgrade.referral_bonus * 100) + '% к рефералам' : ''}
                    </div>
                    <button class="btn" onclick="buyUpgrade('${upgrade.id}')" ${!canBuy || isMaxLevel ? 'disabled' : ''}>
                        ${isMaxLevel ? 'МАКСИМУМ' : (currentLevel === 0 ? 'КУПИТЬ' : 'УЛУЧШИТЬ')} ЗА ${formatNumber(cost)} ₿
                    </button>
                    ${isMaxLevel ? '<div style="color:#ff9800;margin-top:10px;">Максимальный уровень достигнут!</div>' : ''}
                `;
                container.appendChild(card);
            });
        }

        // ====== NFT СИСТЕМА ======
        function generateNFT(type, rarity) {
            const nftType = nftTypes[type] || nftTypes.click_boost;
            const nftRarity = nftRarities[rarity] || nftRarities.common;
            
            return {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                type: type,
                name: nftType.name,
                description: nftType.description,
                rarity: rarity,
                multiplier: nftRarity.multiplier,
                value: nftRarity.price,
                color: nftRarity.color,
                created: Date.now(),
                equipped: false
            };
        }

        async function buyNftBox(type) {
            const prices = {
                'basic': 1000,
                'premium': 5000,
                'legendary': 10000
            };
            
            const price = prices[type];
            if (gameState.balance < price) {
                showNotification(`Недостаточно средств! Нужно ${price} ₿`, 'error');
                return;
            }
            
            gameState.balance -= price;
            gameState.statistics.total_spent += price;
            
            // Определяем шансы в зависимости от типа бокса
            let rarityChances = {};
            if (type === 'basic') {
                rarityChances = { common: 0.7, uncommon: 0.25, rare: 0.05, epic: 0, legendary: 0 };
            } else if (type === 'premium') {
                rarityChances = { common: 0.5, uncommon: 0.3, rare: 0.15, epic: 0.04, legendary: 0.01 };
            } else if (type === 'legendary') {
                rarityChances = { common: 0, uncommon: 0.4, rare: 0.35, epic: 0.2, legendary: 0.05 };
            }
            
            // Выбираем редкость
            const rand = Math.random();
            let rarity = 'common';
            if (rand < rarityChances.common) rarity = 'common';
            else if (rand < rarityChances.common + rarityChances.uncommon) rarity = 'uncommon';
            else if (rand < rarityChances.common + rarityChances.uncommon + rarityChances.rare) rarity = 'rare';
            else if (rand < rarityChances.common + rarityChances.uncommon + rarityChances.rare + rarityChances.epic) rarity = 'epic';
            else rarity = 'legendary';
            
            // Выбираем тип NFT
            const nftTypesArray = Object.keys(nftTypes);
            const nftType = nftTypesArray[Math.floor(Math.random() * nftTypesArray.length)];
            
            // Создаем NFT
            const nft = generateNFT(nftType, rarity);
            gameState.nfts.push(nft);
            
            updateUI();
            await saveGame();
            
            // Показываем NFT
            showNFT(nft);
            showNotification(`Вы получили ${rarity} NFT: ${nft.name}!`, 'success');
        }

        function showNFT(nft) {
            gameState.selected_nft = nft;
            const modal = document.getElementById('nft-open-modal');
            const preview = document.getElementById('nft-preview');
            
            preview.innerHTML = `
                <div style="background: ${nft.color}20; padding: 20px; border-radius: 15px; border: 2px solid ${nft.color}; margin-bottom: 20px;">
                    <h3 style="color:${nft.color}">${nft.name}</h3>
                    <div class="nft-rarity" style="background:${nft.color}30;color:${nft.color}">${nft.rarity}</div>
                    <p>${nft.description}</p>
                    <p style="margin-top:10px;color:#00e676;">Буст: +${Math.floor(nft.multiplier * 100)}%</p>
                    <p style="color:#ff9800;">Стоимость: ${formatNumber(nft.value)} ₿</p>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        async function equipNFT() {
            if (!gameState.selected_nft) return;
            
            const nft = gameState.selected_nft;
            
            // Проверяем, не надет ли уже NFT такого типа
            const alreadyEquipped = gameState.equipped_nfts.find(n => n.type === nft.type);
            if (alreadyEquipped) {
                showNotification(`NFT типа "${nftTypes[nft.type].name}" уже надет!`, 'warning');
                return;
            }
            
            nft.equipped = true;
            gameState.equipped_nfts.push(nft);
            
            // Применяем буст
            applyNFTBoost(nft);
            
            updateUI();
            loadNFTInventory();
            await saveGame();
            
            showNotification(`NFT "${nft.name}" надет!`, 'success');
            closeModal('nft-open-modal');
        }

        async function sellNFT() {
            if (!gameState.selected_nft) return;
            
            const nft = gameState.selected_nft;
            const sellPrice = Math.floor(nft.value * 0.7); // 70% от стоимости
            
            // Удаляем NFT из инвентаря
            const nftIndex = gameState.nfts.findIndex(n => n.id === nft.id);
            if (nftIndex !== -1) {
                gameState.nfts.splice(nftIndex, 1);
            }
            
            // Если NFT был надет, снимаем его
            const equippedIndex = gameState.equipped_nfts.findIndex(n => n.id === nft.id);
            if (equippedIndex !== -1) {
                gameState.equipped_nfts.splice(equippedIndex, 1);
                removeNFTBoost(nft);
            }
            
            gameState.balance += sellPrice;
            gameState.statistics.total_earned += sellPrice;
            
            updateUI();
            loadNFTInventory();
            await saveGame();
            
            showNotification(`NFT продан за ${formatNumber(sellPrice)} ₿!`, 'success');
            closeModal('nft-open-modal');
        }

        function applyNFTBoost(nft) {
            switch(nft.type) {
                case 'click_boost':
                    gameState.nft_boost = 1 + (gameState.equipped_nfts.filter(n => n.type === 'click_boost').reduce((sum, n) => sum + n.multiplier, 0));
                    break;
                case 'passive_boost':
                    gameState.passive_per_sec += nft.multiplier * 0.1;
                    break;
                case 'limit_boost':
                    gameState.click_limit += Math.floor(nft.multiplier * 10);
                    break;
                case 'referral_boost':
                    gameState.referral_bonus += nft.multiplier;
                    break;
            }
        }

        function removeNFTBoost(nft) {
            switch(nft.type) {
                case 'click_boost':
                    gameState.nft_boost = 1 + (gameState.equipped_nfts.filter(n => n.type === 'click_boost').reduce((sum, n) => sum + n.multiplier, 0));
                    break;
                case 'passive_boost':
                    gameState.passive_per_sec -= nft.multiplier * 0.1;
                    break;
                case 'limit_boost':
                    gameState.click_limit -= Math.floor(nft.multiplier * 10);
                    break;
                case 'referral_boost':
                    gameState.referral_bonus -= nft.multiplier;
                    break;
            }
        }

        function loadNFTInventory() {
            const inventory = document.getElementById('nft-inventory');
            const equippedContainer = document.getElementById('equipped-nfts-container');
            
            if (gameState.nfts.length === 0) {
                inventory.innerHTML = '<p style="text-align:center;opacity:0.7;">У вас пока нет NFT</p>';
            } else {
                inventory.innerHTML = '';
                gameState.nfts.forEach(nft => {
                    const nftCard = document.createElement('div');
                    nftCard.className = 'nft-card';
                    nftCard.style.cursor = 'pointer';
                    nftCard.onclick = () => showNFT(nft);
                    nftCard.innerHTML = `
                        <h3>${nft.name}</h3>
                        <div class="nft-rarity" style="background:${nft.color}30;color:${nft.color}">${nft.rarity}</div>
                        <p>${nft.description}</p>
                        <p style="color:#00e676;margin-top:5px;">+${Math.floor(nft.multiplier * 100)}%</p>
                        ${nft.equipped ? '<div style="color:#4fc3f7;margin-top:5px;">✔ Надет</div>' : ''}
                    `;
                    inventory.appendChild(nftCard);
                });
            }
            
            // Надетые NFT
            if (gameState.equipped_nfts.length === 0) {
                equippedContainer.innerHTML = '<p style="text-align:center;opacity:0.7;">Нет надетых NFT</p>';
            } else {
                equippedContainer.innerHTML = '';
                gameState.equipped_nfts.forEach(nft => {
                    const equippedCard = document.createElement('div');
                    equippedCard.className = 'clan-member';
                    equippedCard.style.cursor = 'pointer';
                    equippedCard.onclick = () => showNFT(nft);
                    equippedCard.innerHTML = `
                        <div>
                            <strong>${nft.name}</strong>
                            <div style="font-size:0.8rem;color:${nft.color}">${nft.rarity}</div>
                        </div>
                        <div style="color:#00e676;">+${Math.floor(nft.multiplier * 100)}%</div>
                    `;
                    equippedContainer.appendChild(equippedCard);
                });
            }
        }

        function calculateNFTValue() {
            return gameState.nfts.reduce((sum, nft) => sum + nft.value, 0);
        }

        // ====== МИНИ-ИГРЫ (полная реализация) ======
        function startMinigame(type) {
            currentGame = type;
            const gamesContainer = document.querySelector('.minigame-container');
            const gameContainer = document.getElementById('minigame-container');
            
            gamesContainer.style.display = 'none';
            gameContainer.style.display = 'block';
            gameContainer.innerHTML = '';
            
            switch(type) {
                case 'clicker':
                    startClickerGame();
                    break;
                case 'bubble':
                    startBubbleGame();
                    break;
                case 'memory':
                    startMemoryGame();
                    break;
                case 'typing':
                    startTypingGame();
                    break;
                case 'runner':
                    startRunnerGame();
                    break;
                case 'number':
                    startNumberGame();
                    break;
            }
            
            gameState.minigame_stats[type].played++;
        }

        function backToMinigames() {
            const gamesContainer = document.querySelector('.minigame-container');
            const gameContainer = document.getElementById('minigame-container');
            
            if (gamesContainer && gameContainer) {
                gamesContainer.style.display = 'grid';
                gameContainer.style.display = 'none';
                gameContainer.innerHTML = '';
                
                if (gameInterval) clearInterval(gameInterval);
                if (gameTimeout) clearTimeout(gameTimeout);
                currentGame = null;
            }
        }

        function endMinigame(score) {
            // Рассчитываем награду в зависимости от игры
            let baseReward = 0;
            switch(currentGame) {
                case 'clicker': baseReward = 150; break;
                case 'bubble': baseReward = 200; break;
                case 'memory': baseReward = 250; break;
                case 'typing': baseReward = 300; break;
                case 'runner': baseReward = 400; break;
                case 'number': baseReward = 200; break;
            }
            
            // Награда зависит от результата
            const reward = Math.floor(baseReward * (score / 100));
            
            // Бонус за рефералов
            if (gameState.referrals.length >= 10) {
                reward *= 2;
            }
            
            gameState.balance += reward;
            gameState.statistics.total_earned += reward;
            
            updateUI();
            saveGame();
            
            // Показываем результат
            const gameContainer = document.getElementById('minigame-container');
            gameContainer.innerHTML = `
                <div class="header">
                    <h1>Игра окончена!</h1>
                    <p>Ваш результат: ${score} очков</p>
                    <div class="value" style="color:#00e676;font-size:2rem;margin:20px 0;">+${reward} ₿</div>
                    <button class="btn" onclick="startMinigame('${currentGame}')">Играть снова</button>
                    <button class="btn btn-danger" onclick="backToMinigames()" style="margin-top:10px;">Вернуться</button>
                </div>
            `;
            
            // Обновляем лучший результат
            if (score > gameState.minigame_stats[currentGame].best) {
                gameState.minigame_stats[currentGame].best = score;
                showNotification('Новый рекорд!', 'success');
            }
        }

        // 1. Игра в клики
        function startClickerGame() {
            let timeLeft = 10;
            let clicks = 0;
            
            const gameContainer = document.getElementById('minigame-container');
            gameContainer.innerHTML = `
                <div class="minigame-header">
                    <div>
                        <h3>Кликай как можно быстрее!</h3>
                        <p>У тебя 10 секунд</p>
                    </div>
                    <div class="minigame-timer">${timeLeft}</div>
                </div>
                <div style="text-align:center;">
                    <button class="click-btn" id="game-click-btn" style="width:200px;height:200px;">
                        КЛИКАЙ!
                        <div style="font-size:1rem;margin-top:10px;">Кликов: <span id="click-count">0</span></div>
                    </button>
                </div>
                <button class="btn btn-danger" onclick="backToMinigames()" style="margin-top:20px;">Назад</button>
            `;
            
            const clickBtn = document.getElementById('game-click-btn');
            const clickCount = document.getElementById('click-count');
            const timerDisplay = document.querySelector('.minigame-timer');
            
            clickBtn.addEventListener('click', () => {
                clicks++;
                clickCount.textContent = clicks;
                clickBtn.style.transform = 'scale(0.95)';
                setTimeout(() => clickBtn.style.transform = 'scale(1)', 100);
                
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
            });
            
            gameInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(gameInterval);
                    endMinigame(clicks);
                }
            }, 1000);
        }

        // 2. Игра в пузыри
        function startBubbleGame() {
            let timeLeft = 30;
            let score = 0;
            let bubbles = [];
            
            const gameContainer = document.getElementById('minigame-container');
            gameContainer.innerHTML = `
                <div class="minigame-header">
                    <div>
                        <h3>Лопай крипто-пузыри!</h3>
                        <p>Кликай на появляющиеся пузыри</p>
                    </div>
                    <div style="display:flex;gap:20px;">
                        <div class="minigame-score">${score}</div>
                        <div class="minigame-timer">${timeLeft}</div>
                    </div>
                </div>
                <div class="game-field" id="bubble-field"></div>
                <button class="btn btn-danger" onclick="backToMinigames()">Назад</button>
            `;
            
            const field = document.getElementById('bubble-field');
            
            // Создаем пузыри
            function createBubble() {
                if (timeLeft <= 0) return;
                
                const bubble = document.createElement('div');
                bubble.className = 'crypto-bubble';
                
                const types = ['btc', 'eth', 'doge', 'sol', 'bonus'];
                const type = types[Math.floor(Math.random() * types.length)];
                bubble.classList.add(`bubble-${type}`);
                
                const value = type === 'bonus' ? 10 : 
                             type === 'btc' ? 5 : 
                             type === 'eth' ? 4 : 
                             type === 'sol' ? 3 : 2;
                
                bubble.textContent = type === 'btc' ? '₿' : 
                                   type === 'eth' ? 'Ξ' : 
                                   type === 'doge' ? 'Ð' : 
                                   type === 'sol' ? '◎' : '✨';
                
                const size = 30 + Math.random() * 40;
                bubble.style.width = size + 'px';
                bubble.style.height = size + 'px';
                
                const x = Math.random() * (field.clientWidth - size);
                const y = Math.random() * (field.clientHeight - size);
                bubble.style.left = x + 'px';
                bubble.style.top = y + 'px';
                
                bubble.addEventListener('click', () => {
                    score += value;
                    document.querySelector('.minigame-score').textContent = score;
                    bubble.remove();
                    
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                    
                    if (type === 'bonus') {
                        showNotification('Бонус +10 очков!', 'success');
                    }
                });
                
                field.appendChild(bubble);
                bubbles.push(bubble);
                
                setTimeout(() => {
                    if (bubble.parentNode) {
                        bubble.remove();
                    }
                }, 2000);
            }
            
            // Таймер игры
            gameInterval = setInterval(() => {
                timeLeft--;
                document.querySelector('.minigame-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(gameInterval);
                    clearInterval(bubbleInterval);
                    endMinigame(score);
                }
            }, 1000);
            
            // Создаем пузыри каждые 500ms
            const bubbleInterval = setInterval(createBubble, 500);
            
            // Создаем начальные пузыри
            for (let i = 0; i < 5; i++) {
                setTimeout(createBubble, i * 200);
            }
        }

        // 3. Игра на память
        function startMemoryGame() {
            const symbols = ['₿', 'Ξ', 'Ð', '◎', '★', '⚡', '✨', '♠'];
            const cards = [...symbols, ...symbols];
            
            // Перемешиваем карты
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }
            
            let flippedCards = [];
            let matchedPairs = 0;
            let moves = 0;
            
            const gameContainer = document.getElementById('minigame-container');
            gameContainer.innerHTML = `
                <div class="minigame-header">
                    <div>
                        <h3>Найди пары!</h3>
                        <p>Найди все пары одинаковых символов</p>
                    </div>
                    <div style="display:flex;gap:20px;">
                        <div class="minigame-score">Ходы: <span id="move-count">0</span></div>
                    </div>
                </div>
                <div class="memory-grid" id="memory-grid"></div>
                <button class="btn btn-danger" onclick="backToMinigames()" style="margin-top:20px;">Назад</button>
            `;
            
            const grid = document.getElementById('memory-grid');
            const moveCount = document.getElementById('move-count');
            
            // Создаем карты
            cards.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.symbol = symbol;
                card.dataset.index = index;
                
                card.addEventListener('click', () => {
                    if (flippedCards.length >= 2 || card.classList.contains('flipped') || card.classList.contains('matched')) {
                        return;
                    }
                    
                    card.classList.add('flipped');
                    card.textContent = symbol;
                    flippedCards.push(card);
                    
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                    
                    if (flippedCards.length === 2) {
                        moves++;
                        moveCount.textContent = moves;
                        
                        const [card1, card2] = flippedCards;
                        
                        if (card1.dataset.symbol === card2.dataset.symbol) {
                            // Нашли пару
                            setTimeout(() => {
                                card1.classList.add('matched');
                                card2.classList.add('matched');
                                flippedCards = [];
                                matchedPairs++;
                                
                                if (matchedPairs === symbols.length) {
                                    // Все пары найдены
                                    const score = Math.max(1, 100 - moves * 5);
                                    setTimeout(() => endMinigame(score), 500);
                                }
                            }, 500);
                        } else {
                            // Не совпали
                            setTimeout(() => {
                                card1.classList.remove('flipped');
                                card2.classList.remove('flipped');
                                card1.textContent = '';
                                card2.textContent = '';
                                flippedCards = [];
                            }, 1000);
                        }
                    }
                });
                
                grid.appendChild(card);
            });
        }

        // 4. Игра в печать
        function startTypingGame() {
            let timeLeft = 60;
            let score = 0;
            let currentWord = '';
            let wordsTyped = 0;
            
            const gameContainer = document.getElementById('minigame-container');
            gameContainer.innerHTML = `
                <div class="typing-game">
                    <div class="minigame-header">
                        <div>
                            <h3>Печатай крипто-слова!</h3>
                            <p>Вводи слова как можно быстрее</p>
                        </div>
                        <div style="display:flex;gap:20px;">
                            <div class="minigame-score">${score}</div>
                            <div class="minigame-timer">${timeLeft}</div>
                        </div>
                    </div>
                    <div class="typing-word" id="current-word"></div>
                    <input type="text" class="typing-input" id="typing-input" placeholder="Введите слово здесь..." autocomplete="off">
                    <div class="typing-stats">
                        <div>Набрано слов: <span id="words-count">0</span></div>
                        <div>Точность: <span id="accuracy">100%</span></div>
                    </div>
                    <button class="btn btn-danger" onclick="backToMinigames()" style="margin-top:20px;">Назад</button>
                </div>
            `;
            
            const wordDisplay = document.getElementById('current-word');
            const input = document.getElementById('typing-input');
            const wordsCount = document.getElementById('words-count');
            let correctChars = 0;
            let totalChars = 0;
            
            function newWord() {
                currentWord = cryptoWords[Math.floor(Math.random() * cryptoWords.length)];
                wordDisplay.textContent = currentWord;
                input.value = '';
                input.focus();
            }
            
            input.addEventListener('input', () => {
                totalChars++;
                
                if (input.value.toUpperCase() === currentWord) {
                    // Слово правильно набрано
                    const wordScore = currentWord.length * 10;
                    score += wordScore;
                    correctChars += currentWord.length;
                    wordsTyped++;
                    
                    document.querySelector('.minigame-score').textContent = score;
                    wordsCount.textContent = wordsTyped;
                    
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                    
                    newWord();
                }
                
                // Обновляем точность
                const accuracy = totalChars > 0 ? Math.round((correctChars / totalChars) * 100) : 100;
                document.getElementById('accuracy').textContent = accuracy + '%';
            });
            
            // Таймер игры
            gameInterval = setInterval(() => {
                timeLeft--;
                document.querySelector('.minigame-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(gameInterval);
                    const finalScore = score + (wordsTyped * 5);
                    endMinigame(finalScore);
                }
            }, 1000);
            
            // Начинаем с первого слова
            newWord();
        }

        // 5. Ранер игра
        function startRunnerGame() {
            let score = 0;
            let isJumping = false;
            let gameSpeed = 5;
            let obstacles = [];
            let coins = [];
            
            const gameContainer = document.getElementById('minigame-container');
            gameContainer.innerHTML = `
                <div class="minigame-header">
                    <div>
                        <h3>Крипто-ранер!</h3>
                        <p>Кликай для прыжка, собирай монеты</p>
                    </div>
                    <div class="minigame-score">${score}</div>
                </div>
                <div class="crypto-runner" id="runner-game">
                    <div class="runner-character" id="runner"></div>
                </div>
                <div style="text-align:center;margin:20px 0;">
                    <p>Кликай на экран для прыжка!</p>
                </div>
                <button class="btn btn-danger" onclick="backToMinigames()">Назад</button>
            `;
            
            const game = document.getElementById('runner-game');
            const runner = document.getElementById('runner');
            
            // Обработчик прыжка
            game.addEventListener('click', () => {
                if (!isJumping) {
                    isJumping = true;
                    runner.style.bottom = '100px';
                    
                    setTimeout(() => {
                        runner.style.bottom = '20px';
                        setTimeout(() => {
                            isJumping = false;
                        }, 200);
                    }, 300);
                    
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                }
            });
            
            // Генерация препятствий
            function createObstacle() {
                const obstacle = document.createElement('div');
                obstacle.className = 'runner-obstacle';
                obstacle.style.right = '-50px';
                game.appendChild(obstacle);
                obstacles.push(obstacle);
            }
            
            // Генерация монет
            function createCoin() {
                const coin = document.createElement('div');
                coin.className = 'runner-coin';
                coin.style.right = '-30px';
                coin.style.bottom = (50 + Math.random() * 100) + 'px';
                game.appendChild(coin);
                coins.push(coin);
            }
            
            // Игровой цикл
            let gameTime = 0;
            gameInterval = setInterval(() => {
                gameTime++;
                
                // Увеличиваем сложность
                if (gameTime % 20 === 0) {
                    gameSpeed = Math.min(15, gameSpeed + 0.5);
                }
                
                // Создаем препятствия
                if (Math.random() < 0.02) {
                    createObstacle();
                }
                
                // Создаем монеты
                if (Math.random() < 0.03) {
                    createCoin();
                }
                
                // Двигаем препятствия
                obstacles.forEach((obstacle, index) => {
                    const currentRight = parseFloat(obstacle.style.right);
                    obstacle.style.right = (currentRight + gameSpeed) + 'px';
                    
                    // Проверка столкновения
                    if (currentRight > 50 && currentRight < 100 && !isJumping) {
                        // Столкновение
                        clearInterval(gameInterval);
                        endMinigame(score);
                    }
                    
                    // Удаляем вышедшие за экран
                    if (currentRight > game.clientWidth) {
                        obstacle.remove();
                        obstacles.splice(index, 1);
                    }
                });
                
                // Двигаем монеты
                coins.forEach((coin, index) => {
                    const currentRight = parseFloat(coin.style.right);
                    coin.style.right = (currentRight + gameSpeed) + 'px';
                    
                    // Проверка сбора
                    if (currentRight > 50 && currentRight < 100 && 
                        parseFloat(coin.style.bottom) > 80 && parseFloat(coin.style.bottom) < 120) {
                        // Собрали монету
                        score += 10;
                        document.querySelector('.minigame-score').textContent = score;
                        coin.remove();
                        coins.splice(index, 1);
                        
                        if (tg?.HapticFeedback) {
                            tg.HapticFeedback.impactOccurred('light');
                        }
                    }
                    
                    // Удаляем вышедшие за экран
                    if (currentRight > game.clientWidth) {
                        coin.remove();
                        coins.splice(index, 1);
                    }
                });
                
                // Завершаем игру через 60 секунд
                if (gameTime >= 60) {
                    clearInterval(gameInterval);
                    endMinigame(score);
                }
            }, 50);
        }

        // 6. Игра "Угадай число"
        function startNumberGame() {
            const secretNumber = Math.floor(Math.random() * 100) + 1;
            let attempts = 5;
            let gameEnded = false;
            
            const gameContainer = document.getElementById('minigame-container');
            gameContainer.innerHTML = `
                <div class="header">
                    <h1>Угадай число!</h1>
                    <p>Угадай число от 1 до 100 за ${attempts} попыток</p>
                    <div class="minigame-score" style="margin:20px 0;">Попыток: <span id="attempts-left">${attempts}</span></div>
                </div>
                <input type="number" id="number-input" class="modal-input" placeholder="Введите число" min="1" max="100">
                <button class="btn" onclick="guessNumber()" style="margin-top:10px;">Угадать</button>
                <div id="number-hint" style="margin-top:20px;min-height:60px;"></div>
                <button class="btn btn-danger" onclick="backToMinigames()" style="margin-top:20px;">Назад</button>
            `;
            
            window.guessNumber = function() {
                if (gameEnded) return;
                
                const input = document.getElementById('number-input');
                const guess = parseInt(input.value);
                const hint = document.getElementById('number-hint');
                const attemptsLeft = document.getElementById('attempts-left');
                
                if (!guess || guess < 1 || guess > 100) {
                    showNotification('Введите число от 1 до 100!', 'error');
                    return;
                }
                
                attempts--;
                attemptsLeft.textContent = attempts;
                
                if (guess === secretNumber) {
                    // Выиграли
                    hint.innerHTML = `<div style="color:#00e676;font-size:1.5rem;">🎉 Правильно! Это число ${secretNumber}!</div>`;
                    gameEnded = true;
                    gameState.minigame_stats.number.wins++;
                    
                    const score = attempts * 20 + 100;
                    setTimeout(() => endMinigame(score), 1500);
                    
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('heavy');
                    }
                } else if (attempts === 0) {
                    // Проиграли
                    hint.innerHTML = `<div style="color:#ff4444;font-size:1.5rem;">💔 Попытки закончились! Число было: ${secretNumber}</div>`;
                    gameEnded = true;
                    setTimeout(() => endMinigame(0), 1500);
                } else {
                    // Даем подсказку
                    if (guess < secretNumber) {
                        hint.innerHTML = `<div style="color:#4fc3f7;">🔺 Число больше чем ${guess}</div>`;
                    } else {
                        hint.innerHTML = `<div style="color:#4fc3f7;">🔻 Число меньше чем ${guess}</div>`;
                    }
                    
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                }
                
                input.value = '';
                input.focus();
            };
        }

        // ====== РЕФЕРАЛЬНАЯ СИСТЕМА ======
        function updateReferralUI() {
            if (!gameState.referral_code) {
                gameState.referral_code = generateNewReferralCode();
                saveGame();
            }
            
            document.getElementById('referral-code').textContent = gameState.referral_code;
            document.getElementById('referrals-count').textContent = gameState.referrals.length;
            document.getElementById('referral-earnings').textContent = formatNumber(gameState.referral_earnings) + ' ₿';
            document.getElementById('referral-bonus').textContent = '+' + Math.floor((gameState.referral_bonus - 1) * 100) + '%';
            
            // Рассчитываем доход за 24 часа
            const now = Date.now();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);
            const dailyEarnings = Object.values(gameState.referral_daily_earnings)
                .filter(entry => entry.timestamp > oneDayAgo)
                .reduce((sum, entry) => sum + entry.amount, 0);
            document.getElementById('referral-daily').textContent = formatNumber(dailyEarnings) + ' ₿';
            
            updateReferralsList();
        }

        function updateReferralBonuses() {
            // Бонусы в зависимости от количества рефералов
            if (gameState.referrals.length >= 50) {
                gameState.referral_bonus = 2.5; // +150%
            } else if (gameState.referrals.length >= 25) {
                gameState.referral_bonus = 2.0; // +100%
            } else if (gameState.referrals.length >= 10) {
                gameState.referral_bonus = 1.75; // +75%
            } else if (gameState.referrals.length >= 5) {
                gameState.referral_bonus = 1.5; // +50%
            } else if (gameState.referrals.length >= 3) {
                gameState.referral_bonus = 1.25; // +25%
            } else if (gameState.referrals.length >= 1) {
                gameState.referral_bonus = 1.1; // +10%
            } else {
                gameState.referral_bonus = 1.0;
            }
        }

        async function useReferralCode() {
            const input = document.getElementById('referral-input');
            const code = input.value.trim().toUpperCase();
            
            if (!code) {
                showNotification('Введите реферальный код!', 'error');
                return;
            }
            
            if (code === gameState.referral_code) {
                showNotification('Нельзя использовать свой же код!', 'error');
                return;
            }
            
            if (gameState.used_referral_code) {
                showNotification('Вы уже использовали реферальный код!', 'error');
                return;
            }
            
            // В реальном приложении здесь была бы проверка с сервером
            // Для демо просто добавляем реферала
            gameState.used_referral_code = code;
            gameState.referrals.push({
                code: code,
                date: Date.now(),
                earned: 0
            });
            
            // Награда за использование кода
            const reward = 500;
            gameState.balance += reward;
            gameState.statistics.total_earned += reward;
            
            updateReferralBonuses();
            updateReferralUI();
            updateUI();
            input.value = '';
            closeModal('referral-input-modal');
            
            await saveGame();
            showNotification(`Реферальный код активирован! +${reward} ₿`, 'success');
        }

        function copyReferralCode() {
            navigator.clipboard.writeText(gameState.referral_code);
            showNotification('Реферальный код скопирован!', 'success');
        }

        function updateReferralsList() {
            const container = document.getElementById('referrals-list');
            if (!container) return;
            
            if (gameState.referrals.length === 0) {
                container.innerHTML = '<p style="text-align:center;opacity:0.7;">Пока нет рефералов</p>';
                return;
            }
            
            container.innerHTML = '';
            gameState.referrals.forEach((ref, index) => {
                const refEl = document.createElement('div');
                refEl.className = 'clan-member';
                refEl.innerHTML = `
                    <div>
                        <strong>Реферал ${index + 1}</strong>
                        <div style="font-size:0.8rem;opacity:0.7;">Код: ${ref.code}</div>
                        <div style="font-size:0.8rem;opacity:0.7;">Приглашен: ${new Date(ref.date).toLocaleDateString()}</div>
                    </div>
                    <div style="color:#00e676;">+${formatNumber(ref.earned || 0)} ₿</div>
                `;
                container.appendChild(refEl);
            });
        }

        // ====== СИСТЕМА КЛАНОВ ======
        async function createClan() {
            const nameInput = document.getElementById('clan-name-input');
            const tagInput = document.getElementById('clan-tag-input');
            const descInput = document.getElementById('clan-description-input');
            
            const name = nameInput.value.trim();
            const tag = tagInput.value.trim().toUpperCase();
            const description = descInput.value.trim();
            
            if (!name || !tag || !description) {
                showNotification('Заполните все поля!', 'error');
                return;
            }
            
            if (tag.length < 3 || tag.length > 5) {
                showNotification('Тег клана должен быть от 3 до 5 символов!', 'error');
                return;
            }
            
            const cost = 1000;
            if (gameState.balance < cost) {
                showNotification('Недостаточно средств! Нужно ' + cost + ' ₿', 'error');
                return;
            }
            
            // Проверяем, существует ли уже клан с таким тегом
            if (clansData[tag]) {
                showNotification('Клан с таким тегом уже существует!', 'error');
                return;
            }
            
            gameState.balance -= cost;
            gameState.statistics.total_spent += cost;
            
            gameState.clan = {
                id: Date.now(),
                name: name,
                tag: tag,
                description: description,
                creator_id: getUserId(),
                members: [
                    { 
                        user_id: getUserId(), 
                        username: getUsername(), 
                        role: 'creator', 
                        join_date: Date.now(),
                        contribution: 0
                    }
                ],
                created_at: Date.now(),
                level: 1,
                total_power: gameState.balance,
                settings: {
                    join_type: 'invite', // invite, open, closed
                    min_level: 1
                }
            };
            
            nameInput.value = '';
            tagInput.value = '';
            descInput.value = '';
            
            closeModal('create-clan-modal');
            updateClanUI();
            await saveGame();
            
            showNotification('Клан успешно создан!', 'success');
        }

        function getUsername() {
            if (tg?.initDataUnsafe?.user?.username) {
                return '@' + tg.initDataUnsafe.user.username;
            }
            if (tg?.initDataUnsafe?.user?.first_name) {
                return tg.initDataUnsafe.user.first_name;
            }
            return 'Игрок';
        }

        async function joinClan() {
            const input = document.getElementById('join-clan-input');
            const tag = input.value.trim().toUpperCase();
            
            if (!tag) {
                showNotification('Введите тег клана!', 'error');
                return;
            }
            
            if (gameState.clan) {
                showNotification('Вы уже состоите в клане!', 'error');
                return;
            }
            
            // Проверяем существование клана
            const clan = clansData[tag];
            if (!clan) {
                showNotification('Клан не найден!', 'error');
                return;
            }
            
            // В реальном приложении здесь была бы проверка с сервером
            gameState.clan = {
                id: Date.now(),
                name: clan.name,
                tag: clan.tag,
                description: 'Примерный клан для демонстрации',
                creator_id: 'system',
                members: [
                    { user_id: getUserId(), username: getUsername(), role: 'member', join_date: Date.now(), contribution: 0 }
                ],
                created_at: Date.now() - 86400000,
                level: clan.level,
                total_power: clan.total_power,
                settings: {
                    join_type: 'invite',
                    min_level: 1
                }
            };
            
            input.value = '';
            closeModal('join-clan-modal');
            updateClanUI();
            await saveGame();
            
            showNotification(`Вы вступили в клан ${clan.name}!`, 'success');
        }

        async function leaveClan() {
            if (!gameState.clan) return;
            
            if (gameState.clan.creator_id === getUserId()) {
                showNotification('Создатель клана не может его покинуть!', 'error');
                return;
            }
            
            gameState.clan = null;
            updateClanUI();
            await saveGame();
            
            showNotification('Вы покинули клан!', 'success');
        }

        function updateClanUI() {
            const clanInfo = document.getElementById('clan-info');
            const noClan = document.getElementById('no-clan');
            const topClans = document.getElementById('top-clans-list');
            
            if (gameState.clan) {
                clanInfo.style.display = 'block';
                noClan.style.display = 'none';
                
                document.getElementById('current-clan-name').textContent = gameState.clan.name;
                document.getElementById('current-clan-tag').textContent = '#' + gameState.clan.tag;
                document.getElementById('current-clan-description').textContent = gameState.clan.description;
                document.getElementById('clan-members-count').textContent = gameState.clan.members.length;
                document.getElementById('clan-total-power').textContent = formatNumber(gameState.clan.total_power) + ' ₿';
                document.getElementById('clan-level').textContent = gameState.clan.level;
                
                // Определяем роль пользователя
                const currentUser = gameState.clan.members.find(m => m.user_id === getUserId());
                document.getElementById('clan-user-role').textContent = currentUser?.role === 'creator' ? 'Создатель' : 'Участник';
                
                // Список участников
                const membersList = document.getElementById('clan-members-list');
                membersList.innerHTML = '';
                gameState.clan.members.forEach(member => {
                    const memberEl = document.createElement('div');
                    memberEl.className = 'clan-member';
                    memberEl.innerHTML = `
                        <div>
                            <strong>${member.username || 'Игрок'}</strong>
                            <div style="font-size:0.8rem;opacity:0.7;">${member.role === 'creator' ? 'Создатель' : 'Участник'}</div>
                            <div style="font-size:0.8rem;opacity:0.7;">Вклад: ${formatNumber(member.contribution || 0)} ₿</div>
                        </div>
                        <div class="clan-role">${member.role === 'creator' ? '👑' : '👤'}</div>
                    `;
                    membersList.appendChild(memberEl);
                });
            } else {
                clanInfo.style.display = 'none';
                noClan.style.display = 'block';
            }
            
            // Топ кланов
            topClans.innerHTML = '';
            Object.values(clansData).forEach(clan => {
                const clanEl = document.createElement('div');
                clanEl.className = 'clan-card';
                clanEl.innerHTML = `
                    <h3>${clan.name} <span style="color:#4fc3f7;">#${clan.tag}</span></h3>
                    <div style="display:flex;justify-content:space-between;margin-top:10px;">
                        <div>
                            <div style="font-size:0.9rem;">Участники: ${clan.members}</div>
                            <div style="font-size:0.9rem;">Общая сила: ${formatNumber(clan.total_power)} ₿</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:1.2rem;color:#00e676;">Уровень ${clan.level}</div>
                            <button class="btn" onclick="sendClanRequest('${clan.tag}')" style="margin-top:5px;padding:5px 10px;font-size:0.8rem;">
                                Вступить
                            </button>
                        </div>
                    </div>
                `;
                topClans.appendChild(clanEl);
            });
        }

        function sendClanRequest(tag) {
            if (gameState.clan) {
                showNotification('Вы уже состоите в клане!', 'error');
                return;
            }
            
            document.getElementById('join-clan-input').value = tag;
            openModal('join-clan-modal');
            showNotification(`Запрос на вступление в клан #${tag} отправлен!`, 'success');
        }

        // ====== ОСТАЛЬНЫЕ ФУНКЦИИ ======
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.classList.add('error');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(sectionId + '-section').classList.add('active');
            
            document.querySelectorAll('.nav-tabs button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            if (sectionId !== 'minigames') {
                backToMinigames();
            }
            
            if (sectionId === 'upgrades') renderUpgrades();
            if (sectionId === 'nft') loadNFTInventory();
            if (sectionId === 'clans') updateClanUI();
            if (sectionId === 'referral') updateReferralUI();
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        const promocodes = {
            'CRYPTO100': { reward: 100, uses: 9999 },
            'WELCOME50': { reward: 50, uses: 9999 },
            'FIRST200': { reward: 200, uses: 9999 },
            'BONUS300': { reward: 300, uses: 9999 },
            'NEWPLAYER': { reward: 500, uses: 1 },
            'NFTLOVER': { reward: 1000, uses: 1, nft_bonus: true }
        };

        async function activatePromocode() {
            const input = document.getElementById('promocode-input');
            const code = input.value.trim().toUpperCase();
            
            if (!code) {
                showNotification('Введите промокод!', 'error');
                return;
            }
            
            if (gameState.used_promocodes.includes(code)) {
                showNotification('Этот промокод уже использован!', 'error');
                return;
            }
            
            if (!promocodes[code]) {
                showNotification('Неверный промокод!', 'error');
                return;
            }
            
            const promo = promocodes[code];
            let reward = promo.reward;
            
            // Дополнительные бонусы
            if (promo.nft_bonus) {
                const nft = generateNFT('click_boost', 'rare');
                gameState.nfts.push(nft);
                showNotification(`Бонус NFT: ${nft.name} получен!`, 'success');
            }
            
            gameState.balance += reward;
            gameState.statistics.total_earned += reward;
            gameState.used_promocodes.push(code);
            
            input.value = '';
            closeModal('promocode-modal');
            
            showNotification('Промокод активирован! +' + reward + ' ₿', 'success');
            updateUI();
            await saveGame();
        }

        function startPassiveIncome() {
            setInterval(() => {
                if (gameState.passive_per_sec > 0) {
                    const income = gameState.passive_per_sec / 10;
                    gameState.balance += income;
                    gameState.statistics.total_earned += income;
                    updateUI();
                }
            }, 100);
        }

        function checkDailyBonus() {
            const today = new Date().toDateString();
            const lastBonus = localStorage.getItem('cryptoKombat_last_bonus');
            
            if (lastBonus !== today) {
                const bonus = 100 + (gameState.daily_streak || 0) * 10;
                gameState.balance += bonus;
                gameState.statistics.total_earned += bonus;
                gameState.daily_streak = (gameState.daily_streak || 0) + 1;
                localStorage.setItem('cryptoKombat_last_bonus', today);
                
                setTimeout(() => {
                    showNotification('Ежедневный бонус! +' + bonus + ' ₿ (серия: ' + gameState.daily_streak + ' дней)', 'success');
                    updateUI();
                    saveGame();
                }, 1000);
            }
        }

        // ====== ГЛОБАЛЬНЫЕ ФУНКЦИИ ======
        window.buyUpgrade = buyUpgrade;
        window.showSection = showSection;
        window.resetClickLimit = resetClickLimit;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.activatePromocode = activatePromocode;
        window.startMinigame = startMinigame;
        window.backToMinigames = backToMinigames;
        window.copyReferralCode = copyReferralCode;
        window.useReferralCode = useReferralCode;
        window.createClan = createClan;
        window.joinClan = joinClan;
        window.leaveClan = leaveClan;
        window.sendClanRequest = sendClanRequest;
        window.buyNftBox = buyNftBox;
        window.equipNFT = equipNFT;
        window.sellNFT = sellNFT;

        // ====== ЗАПУСК ИГРЫ ======
        document.addEventListener('DOMContentLoaded', async () => {
            await initGame();
        });
    </script>
</body>
</html>